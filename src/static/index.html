<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>围炉诗社</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Login Section -->
    <section id="login-section" style="display: flex; height: 100vh; justify-content: center; align-items: center; background: var(--bg);">
        <div class="card" style="width: 100%; max-width: 400px; text-align: center;">
            <div style="margin-bottom: 20px;">
                <img src="/static/logo.png" alt="Logo" style="height: 80px;">
            </div>
            <input type="text" id="login-phone" placeholder="手机号">
            <input type="password" id="login-password" placeholder="密码">
            <button onclick="login()" style="width: 100%;">登录</button>
        </div>
    </section>

    <!-- Main Content (Hidden by default) -->
    <div id="main-app" style="display: none;">
        <nav class="navbar">
            <div class="container nav-container">
                <a href="#" class="brand" onclick="showSection('home')">
                    <img src="/static/logo.png" alt="Logo" class="nav-logo">
                </a>
                <button class="menu-toggle" onclick="toggleMobileMenu()">☰</button>
                <div class="nav-links" id="nav-links">
                    <a href="#" onclick="showSection('activities'); closeMobileMenu();">活动</a>
                    <a href="#" onclick="showSection('poems'); closeMobileMenu();">藏诗阁</a>
                    <a href="#" onclick="showSection('tasks'); closeMobileMenu();">事务</a>
                    <a href="#" onclick="showSection('finance'); closeMobileMenu();">财务</a>
                    <a href="#" onclick="showSection('members'); closeMobileMenu();">社员</a>
                    <a href="#" onclick="showSection('admin'); closeMobileMenu();">系统</a>
                    <span class="nav-user" id="nav-current-user"></span>
                    <a href="#" onclick="openChangePasswordModal(); closeMobileMenu();">修改密码</a>
                    <a href="#" onclick="logout(); closeMobileMenu();" style="color: #e74c3c;">退出</a>
                </div>
            </div>
        </nav>

        <main class="container">
        
        <!-- Global Search Bar -->
        <div class="search-container">
            <input type="text" id="global-search-input" placeholder="搜索 活动 / 藏诗阁 / 事务 ..." style="width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        </div>

        <!-- Search Results Section (Hidden by default) -->
        <section id="search-results-section" style="display:none;">
            <h3>搜索结果</h3>
            <div id="search-results-container"></div>
        </section>

        <!-- Home Section -->
        <section id="home" class="active">
            <!-- 第一行：近期活动、最新诗作、围炉值排行榜 -->
            <div class="home-row-1">
                <div class="card home-card">
                    <h3>近期活动</h3>
                    <div id="home-activities-list" class="home-card-content">加载中...</div>
                </div>

                <div class="card home-card">
                    <h3>最新诗作</h3>
                    <div id="latest-poems-list" class="home-card-content">加载中...</div>
                </div>

                <div class="card home-card">
                    <h3 id="points-ranking-title">年度排行榜</h3>
                    <div id="points-ranking-list" class="home-card-content">加载中...</div>
                </div>
            </div>

            <!-- 第二行：今日推荐 -->
            <div class="card" style="margin-top: 20px;">
                <h3>今日推荐</h3>
                <div id="daily-poem">加载中...</div>
            </div>
        </section>

        <!-- Admin Section -->
        <section id="admin" style="display:none;">
            <h2>后台管理仪表盘</h2>
            <div class="card">
                <h3>设备状态</h3>
                <div class="system-status-grid">
                    <div class="status-item">
                        <span class="status-label">设备</span>
                        <span class="status-value" id="admin-platform">-</span>
                    </div>
                    <div class="status-item status-bar-item">
                        <div class="status-bar-header">
                            <span class="status-label">数据存储空间（Flash）</span>
                            <span class="status-text" id="admin-storage-text">-</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-bar-fill" id="admin-storage-bar"></div>
                        </div>
                    </div>
                    <div class="status-item status-bar-item">
                        <div class="status-bar-header">
                            <span class="status-label">运行内存使用</span>
                            <span class="status-text" id="admin-ram-text">-</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-bar-fill" id="admin-ram-bar"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3>数据统计</h3>
                <div class="stats-grid" id="admin-data-stats">
                    <div class="stat-card">
                        <span class="stat-icon">👥</span>
                        <div class="stat-info">
                            <span class="stat-value" id="stat-members">-</span>
                            <span class="stat-name">社员</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon">📜</span>
                        <div class="stat-info">
                            <span class="stat-value" id="stat-poems">-</span>
                            <span class="stat-name">诗作</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon">🎉</span>
                        <div class="stat-info">
                            <span class="stat-value" id="stat-activities">-</span>
                            <span class="stat-name">活动</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon">📋</span>
                        <div class="stat-info">
                            <span class="stat-value" id="stat-tasks">-</span>
                            <span class="stat-name">事务</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon">💰</span>
                        <div class="stat-info">
                            <span class="stat-value" id="stat-finance">-</span>
                            <span class="stat-name">财务记录</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3>系统设置</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">系统名称</label>
                    <div class="admin-field-row">
                        <input type="text" id="setting-system-name" placeholder="围炉诗社·理事台" style="flex:1;">
                        <button onclick="saveSystemName()">保存</button>
                    </div>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">积分名称</label>
                    <div class="admin-field-row">
                        <input type="text" id="setting-points-name" placeholder="围炉值" style="flex:1;">
                        <button onclick="savePointsName()">保存</button>
                    </div>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">密码加盐值 (Salt)</label>
                    <div class="admin-field-row">
                        <input type="text" id="setting-password-salt" placeholder="weilu2018" style="flex:1;">
                        <button onclick="savePasswordSalt()" style="background:#e67e22;">保存</button>
                    </div>
                    <p style="font-size:0.8em; color:#e74c3c; margin-top:8px;">注意：修改Salt后需要重新迁移所有密码！</p>
                </div>
                <div>
                    <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">密码迁移</label>
                    <p style="font-size:0.8em; color:#666; margin-bottom:8px;">将明文密码转换为哈希存储</p>
                    <button onclick="migratePasswords()" style="background:#e67e22;">执行密码迁移</button>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3>WiFi 设置</h3>
                <p style="color:#666; font-size:0.85em; margin-bottom:15px;">配置设备网络连接，支持STA客户端模式和AP热点模式。</p>
                
                <!-- STA模式 -->
                <div style="margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid #eee;">
                    <h4 style="font-size:0.95em; color:#333; margin-bottom:15px; display:flex; align-items:center;">
                        <span style="background:var(--accent); color:#fff; width:20px; height:20px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:0.75em; margin-right:8px;">1</span>
                        STA模式（连接WiFi）
                    </h4>
                    <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; margin-bottom:15px;">
                        <div>
                            <label style="display:block; font-size:0.85em; color:#666; margin-bottom:4px;">WiFi名称 (SSID)</label>
                            <input type="text" id="wifi-ssid" placeholder="输入WiFi名称" style="width:100%;">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.85em; color:#666; margin-bottom:4px;">WiFi密码</label>
                            <input type="password" id="wifi-password" placeholder="输入WiFi密码" style="width:100%;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom:12px;">
                        <label style="display:block; font-size:0.85em; color:#666; margin-bottom:8px;">IP地址获取方式</label>
                        <div style="display:flex; gap:20px;">
                            <label style="display:flex; align-items:center; cursor:pointer; font-size:0.9em;">
                                <input type="radio" name="wifi-ip-mode" value="dhcp" checked onchange="toggleStaticIpFields()" style="margin-right:6px;">
                                自动获取 (DHCP)
                            </label>
                            <label style="display:flex; align-items:center; cursor:pointer; font-size:0.9em;">
                                <input type="radio" name="wifi-ip-mode" value="static" onchange="toggleStaticIpFields()" style="margin-right:6px;">
                                静态IP
                            </label>
                        </div>
                    </div>
                    
                    <div id="static-ip-fields" style="display:none; padding:15px; background:#f8f9fa; border-radius:8px; margin-top:10px;">
                        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;">
                            <div>
                                <label style="display:block; font-size:0.8em; color:#666; margin-bottom:4px;">IP地址</label>
                                <input type="text" id="wifi-sta-ip" placeholder="192.168.1.100" style="width:100%;">
                            </div>
                            <div>
                                <label style="display:block; font-size:0.8em; color:#666; margin-bottom:4px;">子网掩码</label>
                                <input type="text" id="wifi-sta-subnet" placeholder="255.255.255.0" style="width:100%;">
                            </div>
                            <div>
                                <label style="display:block; font-size:0.8em; color:#666; margin-bottom:4px;">网关</label>
                                <input type="text" id="wifi-sta-gateway" placeholder="192.168.1.1" style="width:100%;">
                            </div>
                            <div>
                                <label style="display:block; font-size:0.8em; color:#666; margin-bottom:4px;">DNS服务器</label>
                                <input type="text" id="wifi-sta-dns" placeholder="8.8.8.8" style="width:100%;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AP模式 -->
                <div style="margin-bottom:20px;">
                    <h4 style="font-size:0.95em; color:#333; margin-bottom:15px; display:flex; align-items:center;">
                        <span style="background:#6c757d; color:#fff; width:20px; height:20px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:0.75em; margin-right:8px;">2</span>
                        AP模式（热点）
                    </h4>
                    <p style="font-size:0.8em; color:#888; margin-bottom:12px;">WiFi连接失败时自动启用，用于首次配置或应急访问</p>
                    <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; margin-bottom:12px;">
                        <div>
                            <label style="display:block; font-size:0.85em; color:#666; margin-bottom:4px;">热点名称</label>
                            <input type="text" id="wifi-ap-ssid" placeholder="围炉诗社小热点" style="width:100%;">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.85em; color:#666; margin-bottom:4px;">热点密码</label>
                            <input type="password" id="wifi-ap-password" placeholder="设置热点密码" style="width:100%;">
                        </div>
                    </div>
                    <div>
                        <label style="display:block; font-size:0.85em; color:#666; margin-bottom:4px;">AP模式IP地址</label>
                        <input type="text" id="wifi-ap-ip" placeholder="192.168.18.1" style="width:50%;">
                        <p style="font-size:0.75em; color:#999; margin-top:4px;">连接热点后，访问此IP进入系统后台</p>
                    </div>
                </div>
                
                <div style="display:flex; gap:10px; justify-content:flex-end; padding-top:15px; border-top:1px solid #eee;">
                    <button onclick="loadWifiConfig()" style="background:#6c757d;">刷新配置</button>
                    <button onclick="saveWifiConfig()">保存配置</button>
                </div>
                <p style="font-size:0.8em; color:#e67e22; margin-top:12px; text-align:center;">提示：WiFi配置修改后需要重启设备才能生效</p>
            </div>

            <div class="card" style="margin-top:20px;" id="admin-custom-fields">
                <h3>社员资料自定义字段管理</h3>
                <p style="color:#666; font-size:0.85em; margin-bottom:12px;">此处可定义所有社员的额外资料字段。</p>
                <div id="settings-fields-list" style="margin-bottom:12px;">Loading...</div>
                <div class="admin-field-row">
                    <input type="text" id="new-field-label" placeholder="输入新字段名称 (如: 微信号)" style="flex:1">
                    <select id="new-field-type" style="width: 100px;">
                        <option value="text">文本</option>
                        <option value="number">数字</option>
                        <option value="date">日期</option>
                        <option value="email">邮箱</option>
                    </select>
                    <button onclick="addCustomFieldInput()">添加字段</button>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3>登录日志</h3>
                <p style="color:#666; font-size:0.9em;">最近20条登录记录</p>
                <div id="login-logs-list" style="max-height: 300px; overflow-y: auto;">加载中...</div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3>数据备份</h3>
                <p style="color:#666; font-size:0.85em; margin-bottom:15px;">导出或导入全站数据备份，用于数据迁移或灾难恢复。</p>
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:200px;">
                        <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">导出数据</label>
                        <button onclick="exportBackup()" style="width:100%; background:var(--accent);">下载备份文件</button>
                    </div>
                    <div style="flex:1; min-width:200px;">
                        <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">导入数据</label>
                        <input type="file" id="backup-file-input" accept=".json" style="display:none;" onchange="importBackup(event)">
                        <button onclick="document.getElementById('backup-file-input').click()" style="width:100%; background:#e67e22;">选择备份文件</button>
                    </div>
                </div>
                <p style="font-size:0.8em; color:#e74c3c; margin-top:12px;">警告：导入数据将覆盖现有数据，请谨慎操作！</p>
            </div>
        </section>

        <!-- Poems Section -->
        <section id="poems" style="display:none;">
            <div class="header-row">
                <h2>藏诗阁</h2>
                <button onclick="openPoemModal()">撰写新作品</button>
            </div>
            
            <div id="poem-list"></div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button id="poem-load-more" onclick="showAllPoems()" style="display:none; width: 100%; padding: 10px; background: #f5f5f5; border: 1px solid #ddd; color: #666; border-radius: 8px;">查看更多作品</button>
            </div>
        </section>

        <!-- Activities Section -->
        <section id="activities" style="display:none;">
            <div class="header-row">
                <h2>诗社活动</h2>
                <button onclick="openActivityModal()" id="btn-add-activity" style="display:none;">发起活动</button>
            </div>
            <div id="activity-list"></div>
        </section>

        <!-- Finance Section -->
        <section id="finance" style="display:none;">
            <div class="header-row">
                <h2>财务公示</h2>
                <button onclick="toggleModal('modal-finance')" id="btn-add-finance" style="display:none;">记一笔</button>
            </div>
            <div class="card finance-stats">
                <div class="finance-balance">
                    <h4>当前余额</h4>
                    <span id="balance" class="balance-value">0</span>
                </div>
                <div class="finance-details">
                    <div class="stat-item">
                        <h4>总收入</h4>
                        <span id="total-income" class="money plus">0</span>
                    </div>
                    <div class="stat-item">
                        <h4>总支出</h4>
                        <span id="total-expense" class="money minus">0</span>
                    </div>
                </div>
            </div>
            <table class="table">
                <thead><tr><th>日期</th><th>摘要</th><th>金额</th><th>经办</th></tr></thead>
                <tbody id="finance-list"></tbody>
            </table>
        </section>

        <!-- Tasks Section -->
        <section id="tasks" style="display:none;">
            <div class="header-row">
                <h2 id="tasks-section-title">事务与积分</h2>
                <button onclick="openTaskModal()" id="btn-add-task" style="display:none;">发布事务</button>
            </div>
            <div id="task-list"></div>
        </section>

        <!-- Members Section -->
        <section id="members" style="display:none;">
            <div class="header-row">
                <h2>社员名录</h2>
                <button onclick="openMemberModal()" id="btn-add-member" style="display:none;">录入社员</button>
            </div>
            <div id="member-list" class="grid"></div>
        </section>
    </main>

    <!-- Modals -->
    <div id="modal-poem" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-poem')">&times;</span>
            <h3>发布新作</h3>
            <input type="text" id="p-title" placeholder="诗名/标题">
            <textarea id="p-content" placeholder="正文" rows="6"></textarea>
            <select id="p-type">
                <option>古体诗</option>
                <option>绝句</option>
                <option>律诗</option>
                <option>排律</option>
                <option>词</option>
                <option>现代诗</option>
                <option>文章</option>
                <option>其它</option>
            </select>
            <input type="datetime-local" id="p-date" placeholder="发布时间">
            
            <div id="poem-modal-actions" style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <!-- Buttons injected by JS -->
            </div>
        </div>
    </div>

    <div id="modal-finance" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-finance')">&times;</span>
            <h3>财务记账</h3>
            <select id="f-type">
                <option value="income">收入</option>
                <option value="expense">支出</option>
            </select>
            <select id="f-category">
                <option value="会费">会费</option>
                <option value="活动费用">活动费用</option>
                <option value="物资采购">物资采购</option>
                <option value="稿费">稿费</option>
                <option value="捐赠">捐赠</option>
                <option value="其他">其他</option>
            </select>
            <input type="number" id="f-amount" placeholder="金额">
            <input type="text" id="f-summary" placeholder="摘要">
            <input type="text" id="f-handler" placeholder="经办人">
            <button onclick="submitFinance()">提交</button>
        </div>
    </div>

    <div id="modal-task" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-task')">&times;</span>
            <h3 id="task-modal-title">发布事务</h3>
            <input type="text" id="t-title" placeholder="事务标题">
            <textarea id="t-description" placeholder="事务描述" rows="6"></textarea>
            <input type="number" id="t-reward" placeholder="奖励积分" min="0">
            <div id="task-modal-actions" style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button onclick="submitTask()">发布</button>
            </div>
        </div>
    </div>

    <div id="modal-member" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-member')">&times;</span>
            <h3>录入新社员</h3>
            <input type="text" id="m-name" placeholder="姓名">
            <input type="text" id="m-alias" placeholder="雅号/花名">
            <input type="text" id="m-phone" placeholder="手机号 (用于登录)">
            <input type="password" id="m-password" placeholder="初始密码">
            <select id="m-role">
                <option value="member">普通社员</option>
                <option value="director">理事</option>
                <option value="finance">财务</option>
                <option value="admin">管理员</option>
                <option value="super_admin">超级管理员</option>
            </select>
            <input type="number" id="m-points" placeholder="初始积分 (默认0)">
            <div id="m-custom-fields-container" style="margin: 10px 0; border-top: 1px solid #eee; padding-top: 10px;"></div>
            <button onclick="submitMember()">保存</button>
        </div>
    </div>

    <div id="modal-change-password" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-change-password')">&times;</span>
            <h3>修改密码</h3>
            <input type="password" id="cp-old-password" placeholder="原密码">
            <input type="password" id="cp-new-password" placeholder="新密码">
            <input type="password" id="cp-confirm-password" placeholder="确认新密码">
            <button onclick="submitChangePassword()">确认修改</button>
        </div>
    </div>

    <div id="modal-activity" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-activity')">&times;</span>
            <h3>发起活动</h3>
            <input type="text" id="act-title" placeholder="活动主题">
            <textarea id="act-desc" placeholder="活动详情/说明" rows="6"></textarea>
            <input type="datetime-local" id="act-date" placeholder="时间">
            <input type="text" id="act-location" placeholder="活动地点">
            <select id="act-status">
                <option value="筹备中">筹备中</option>
                <option value="报名中">报名中</option>
                <option value="进行中">进行中</option>
                <option value="已结束">已结束</option>
            </select>
            <button onclick="submitActivity()">发布</button>
        </div>
    </div>

    <!-- Read-Only Activity Detail Modal -->
    <div id="modal-activity-view" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-activity-view')">&times;</span>
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-top:35px; margin-bottom:20px;">
                <h3 id="view-act-title" style="margin:0; line-height:1.5; flex:1; padding-right:12px;"></h3>
                <span id="view-act-status" class="points-badge" style="flex-shrink:0; line-height:1.5;"></span>
            </div>
            <!-- Combined Info Area -->
            <div id="view-act-container" style="color:#444;"></div>
            
            <div id="view-act-actions" style="margin-top:20px; padding-top:15px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px;"></div>
        </div>
    </div>
    
    </div> <!-- Close main-app div -->
    <script src="/static/app.js"></script>
</body>
</html>
