<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>围炉诗社</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Login Section -->
    <section id="login-section" style="display: flex; height: 100vh; justify-content: center; align-items: center; background: var(--bg);">
        <div class="card" style="width: 100%; max-width: 400px; text-align: center;">
            <div style="margin-bottom: 20px;">
                <img src="/static/logo.png" alt="Logo" style="height: 80px;">
            </div>
            <input type="text" id="login-phone" placeholder="手机号">
            <input type="password" id="login-password" placeholder="密码">
            <button onclick="login()" style="width: 100%;">登录</button>
        </div>
    </section>

    <!-- Main Content (Hidden by default) -->
    <div id="main-app" style="display: none;">
        <nav class="navbar">
            <div class="container nav-container">
                <a href="#" class="brand" onclick="showSection('home')">
                    <img src="/static/logo.png" alt="Logo" class="nav-logo">
                </a>
                <button class="menu-toggle" onclick="toggleMobileMenu()">☰</button>
                <div class="nav-links" id="nav-links">
                    <a href="#" onclick="showSection('activities'); closeMobileMenu();">活动</a>
                    <a href="#" onclick="showSection('poems'); closeMobileMenu();">藏诗阁</a>
                    <a href="#" onclick="showSection('tasks'); closeMobileMenu();">事务</a>
                    <a href="#" onclick="showSection('finance'); closeMobileMenu();">财务</a>
                    <a href="#" onclick="showSection('members'); closeMobileMenu();">社员</a>
                    <a href="#" onclick="showSection('admin'); closeMobileMenu();">系统</a>
                    <a href="#" onclick="logout(); closeMobileMenu();" style="color: #e74c3c;">退出</a>
                </div>
            </div>
        </nav>

        <main class="container">
        
        <!-- Global Search Bar -->
        <div class="search-container">
            <input type="text" id="global-search-input" placeholder="搜索 活动 / 藏诗阁 / 事务 ..." style="width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        </div>

        <!-- Search Results Section (Hidden by default) -->
        <section id="search-results-section" style="display:none;">
            <h3>搜索结果</h3>
            <div id="search-results-container"></div>
        </section>

        <!-- Home Section -->
        <section id="home" class="active">
            <div class="card" style="margin-bottom: 20px;">
                <h3>近期活动</h3>
                <div id="home-activities-list">加载中...</div>
            </div>

            <div class="home-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <div class="card">
                    <h3>今日推荐</h3>
                    <div id="daily-poem">加载中...</div>
                </div>

                <div class="card">
                    <h3>最新诗作</h3>
                    <div id="latest-poems-list">加载中...</div>
                </div>

                <div class="card">
                    <h3 id="points-ranking-title">积分排行榜</h3>
                    <div id="points-ranking-list">加载中...</div>
                </div>
            </div>
        </section>

        <!-- Admin Section -->
        <section id="admin" style="display:none;">
            <h2>后台管理仪表盘</h2>
            <div class="card">
                <h3>设备状态</h3>
                <div class="grid dashboard-grid">
                    <div class="dash-item">
                        <span>设备名称</span>
                        <strong id="admin-platform">-</strong>
                    </div>
                    <div class="dash-item">
                        <span>总存储 (Flash)</span>
                        <strong id="admin-total-storage">-</strong>
                    </div>
                    <div class="dash-item">
                        <span>剩余存储</span>
                        <strong id="admin-free-storage">-</strong>
                    </div>
                    <div class="dash-item">
                        <span>当前内存 (RAM)</span>
                        <strong id="admin-ram">-</strong>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px;" id="admin-custom-fields">
                <h3>社员资料自定义字段管理</h3>
                <p style="color:#666; font-size:0.9em;">此处可定义所有社员的额外资料字段。</p>
                <div id="settings-fields-list" style="margin-bottom:15px;">Loading...</div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="new-field-label" placeholder="输入新字段名称 (如: 微信号)" style="flex:1">
                    <select id="new-field-type" style="width: 100px;">
                        <option value="text">文本</option>
                        <option value="number">数字</option>
                        <option value="date">日期</option>
                        <option value="email">邮箱</option>
                    </select>
                    <button onclick="addCustomFieldInput()">添加字段</button>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3>系统设置</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-size:0.9em; color:#666; margin-bottom:5px;">积分名称</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="setting-points-name" placeholder="围炉值" style="flex:1; margin:0;">
                        <button onclick="savePointsName()" style="white-space:nowrap;">保存</button>
                    </div>
                </div>
                <div>
                    <label style="display:block; font-size:0.9em; color:#666; margin-bottom:5px;">密码加盐值 (Salt)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="setting-password-salt" placeholder="weilu2018" style="flex:1; margin:0;">
                        <button onclick="savePasswordSalt()" style="white-space:nowrap; background:#e67e22;">保存</button>
                    </div>
                    <p style="font-size:0.8em; color:#e74c3c; margin-top:5px;">注意：修改Salt后需要重新迁移所有密码！</p>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3>登录日志</h3>
                <p style="color:#666; font-size:0.9em;">最近20条登录记录</p>
                <div id="login-logs-list" style="max-height: 300px; overflow-y: auto;">加载中...</div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3>数据维护</h3>
                <p style="color:#666; font-size:0.9em;">密码安全迁移（将明文密码转换为哈希存储）</p>
                <button onclick="migratePasswords()" style="background:#e67e22;">执行密码迁移</button>
            </div>
        </section>

        <!-- Poems Section -->
        <section id="poems" style="display:none;">
            <div class="header-row">
                <h2>藏诗阁</h2>
                <button onclick="openPoemModal()">撰写新作品</button>
            </div>
            
            <div id="poem-list"></div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button id="poem-load-more" onclick="showAllPoems()" style="display:none; width: 100%; padding: 10px; background: #f5f5f5; border: 1px solid #ddd; color: #666; border-radius: 8px;">查看更多作品</button>
            </div>
        </section>

        <!-- Activities Section -->
        <section id="activities" style="display:none;">
            <div class="header-row">
                <h2>诗社活动</h2>
                <button onclick="openActivityModal()" id="btn-add-activity" style="display:none;">发起活动</button>
            </div>
            <div id="activity-list"></div>
        </section>

        <!-- Finance Section -->
        <section id="finance" style="display:none;">
            <div class="header-row">
                <h2>财务公示</h2>
                <button onclick="toggleModal('modal-finance')">记一笔</button>
            </div>
            <div class="card stats-card">
                <div class="stat-item">
                    <h4>总收入</h4>
                    <span id="total-income" class="money plus">0</span>
                </div>
                <div class="stat-item">
                    <h4>总支出</h4>
                    <span id="total-expense" class="money minus">0</span>
                </div>
                <div class="stat-item">
                    <h4>结余</h4>
                    <span id="balance" class="money">0</span>
                </div>
            </div>
            <table class="table">
                <thead><tr><th>日期</th><th>摘要</th><th>金额</th><th>经办</th></tr></thead>
                <tbody id="finance-list"></tbody>
            </table>
        </section>

        <!-- Tasks Section -->
        <section id="tasks" style="display:none;">
            <h2 id="tasks-section-title">事务与积分</h2>
            <div id="task-list"></div>
        </section>

        <!-- Members Section -->
        <section id="members" style="display:none;">
            <div class="header-row">
                <h2>社员名录</h2>
                <button onclick="openMemberModal()" id="btn-add-member" style="display:none;">录入社员</button>
            </div>
            <div id="member-list" class="grid"></div>
        </section>
    </main>

    <!-- Modals -->
    <div id="modal-poem" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-poem')">&times;</span>
            <h3>发布新作</h3>
            <input type="text" id="p-title" placeholder="诗名/标题">
            <textarea id="p-content" placeholder="正文" rows="6"></textarea>
            <select id="p-type">
                <option>绝句</option>
                <option>律诗</option>
                <option>词</option>
                <option>现代诗</option>
                <option>文章</option>
            </select>
            <input type="datetime-local" id="p-date" placeholder="发布时间">
            
            <div id="poem-modal-actions" style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <!-- Buttons injected by JS -->
            </div>
        </div>
    </div>

    <div id="modal-finance" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-finance')">&times;</span>
            <h3>财务记账</h3>
            <select id="f-type">
                <option value="income">收入</option>
                <option value="expense">支出</option>
            </select>
            <select id="f-category">
                <option value="会费">会费</option>
                <option value="活动费用">活动费用</option>
                <option value="物资采购">物资采购</option>
                <option value="稿费">稿费</option>
                <option value="捐赠">捐赠</option>
                <option value="其他">其他</option>
            </select>
            <input type="number" id="f-amount" placeholder="金额">
            <input type="text" id="f-summary" placeholder="摘要">
            <input type="text" id="f-handler" placeholder="经办人">
            <button onclick="submitFinance()">提交</button>
        </div>
    </div>

    <div id="modal-member" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-member')">&times;</span>
            <h3>录入新社员</h3>
            <input type="text" id="m-name" placeholder="姓名">
            <input type="text" id="m-alias" placeholder="雅号/花名">
            <input type="text" id="m-phone" placeholder="手机号 (用于登录)">
            <input type="text" id="m-password" placeholder="初始密码">
            <select id="m-role">
                <option value="member">普通社员</option>
                <option value="director">理事</option>
                <option value="finance">财务</option>
                <option value="admin">管理员</option>
                <option value="super_admin">超级管理员</option>
            </select>
            <input type="number" id="m-points" placeholder="初始积分 (默认0)">
            <div id="m-custom-fields-container" style="margin: 10px 0; border-top: 1px solid #eee; padding-top: 10px;"></div>
            <button onclick="submitMember()">保存</button>
        </div>
    </div>

    <div id="modal-activity" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-activity')">&times;</span>
            <h3>发起活动</h3>
            <input type="text" id="act-title" placeholder="活动主题">
            <textarea id="act-desc" placeholder="活动详情/说明" rows="6"></textarea>
            <input type="datetime-local" id="act-date" placeholder="时间">
            <input type="text" id="act-location" placeholder="活动地点">
            <select id="act-status">
                <option value="筹备中">筹备中</option>
                <option value="报名中">报名中</option>
                <option value="进行中">进行中</option>
                <option value="已结束">已结束</option>
            </select>
            <button onclick="submitActivity()">发布</button>
        </div>
    </div>

    <!-- Read-Only Activity Detail Modal -->
    <div id="modal-activity-view" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-activity-view')">&times;</span>
            <h3 id="view-act-title" style="margin-top:10px; margin-bottom:20px; padding-right:30px; line-height:1.4;"></h3>
            <!-- Combined Info Area -->
            <div id="view-act-container" style="color:#444;"></div>
            
            <div style="margin-top:20px; padding-top:20px; border-top:1px solid #eee; text-align:right; display:flex; justify-content:space-between; align-items:center;">
                <div id="view-act-actions"></div>
                <span id="view-act-status" class="points-badge" style="float:none;"></span>
            </div>
        </div>
    </div>
    
    </div> <!-- Close main-app div -->
    <script src="/static/app.js"></script>
</body>
</html>
