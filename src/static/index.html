<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>围炉诗社</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- 维护模式页面 -->
    <section id="maintenance-section" class="hidden" style="display: flex; height: 100vh; justify-content: center; align-items: center; background: var(--bg);">
        <div class="card" style="width: 100%; max-width: 400px; text-align: center; padding: 40px 30px;">
            <div style="font-size: 64px; margin-bottom: 20px;">🔧</div>
            <h2 style="margin: 0 0 15px 0; color: var(--text);">系统维护中</h2>
            <p style="color: #666; margin-bottom: 30px; line-height: 1.6;">网站正在进行升级维护，请稍后再访问。给您带来不便，敬请谅解。</p>
            <button onclick="showMaintenanceLogin()" style="width: 100%; background: var(--accent);">管理员登录</button>
        </div>
    </section>

    <!-- Login Section (默认隐藏) -->
    <section id="login-section" class="hidden" style="display: flex; height: 100vh; justify-content: center; align-items: center; background: var(--bg);">
        <div class="card" style="width: 100%; max-width: 400px; text-align: center;">
            <div style="margin-bottom: 20px;">
                <img src="/static/logo.png" alt="Logo" style="height: 80px;">
            </div>
            <input type="text" id="login-phone" placeholder="手机号 *">
            <input type="password" id="login-password" placeholder="密码 *">
            <button onclick="login()" style="width: 100%;">登录</button>
        </div>
    </section>

    <!-- Main Content (Hidden by default) -->
    <div id="main-app" class="hidden">
        <nav class="navbar">
            <div class="container nav-container">
                <a href="#" class="brand" onclick="showSection('home')">
                    <img src="/static/logo.png" alt="Logo" class="nav-logo">
                </a>
                <button class="menu-toggle" onclick="toggleMobileMenu()">☰</button>
                <div class="nav-links" id="nav-links">
                    <a href="#" onclick="showSection('activities'); closeMobileMenu();">活动</a>
                    <a href="#" onclick="showSection('chat'); closeMobileMenu();">摆龙门阵</a>
                    <a href="#" onclick="showSection('poems'); closeMobileMenu();">藏诗阁</a>
                    <a href="#" onclick="showSection('tasks'); closeMobileMenu();" class="nav-login-required">事务</a>
                    <a href="#" onclick="showSection('finance'); closeMobileMenu();" class="nav-login-required">财务</a>
                    <a href="#" onclick="showSection('members'); closeMobileMenu();">社员</a>
                    <a href="#" onclick="showSection('admin'); closeMobileMenu();" class="nav-login-required">系统</a>
                    <a href="#" class="nav-user-link nav-login-required" onclick="openProfileModal(); closeMobileMenu();" id="nav-current-user"></a>
                    <a href="#" onclick="logout(); closeMobileMenu();" class="nav-login-required" style="color: #e74c3c;">退出</a>
                    <a href="#" onclick="showLoginPage(); closeMobileMenu();" id="nav-login-btn" class="nav-guest-only" style="color: var(--accent); font-weight: 500;">登录</a>
                </div>
            </div>
        </nav>

        <main class="container">
        
        <!-- Global Search Bar -->
        <div class="search-container">
            <input type="text" id="global-search-input" placeholder="搜索 活动 / 藏诗阁 / 事务 ..." style="width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        </div>

        <!-- 年度诗词周报热力图 -->
        <div class="weekly-heatmap-container" id="weekly-heatmap-container">
            <div class="heatmap-header">
                <h4 class="heatmap-title">年度热力图</h4>
                <select id="heatmap-year-select" onchange="loadWeeklyHeatmap()"></select>
            </div>
            <div class="heatmap-grid" id="weekly-heatmap"></div>
            <div class="heatmap-info" id="heatmap-info"></div>
            <div class="heatmap-legend">
                <span class="legend-label">少</span>
                <span class="legend-box level-0"></span>
                <span class="legend-box level-1"></span>
                <span class="legend-box level-2"></span>
                <span class="legend-box level-3"></span>
                <span class="legend-box level-4"></span>
                <span class="legend-label">多</span>
                <span class="legend-divider"></span>
                <span class="legend-box activity"></span>
                <span class="legend-label">活动周</span>
            </div>
        </div>

        <!-- Search Results Section (Hidden by default) -->
        <section id="search-results-section" class="hidden">
            <h3>搜索结果</h3>
            <div id="search-results-container"></div>
        </section>

        <!-- Home Section -->
        <section id="home" class="active">
            <!-- 第一行：近期活动、最新诗作、围炉值排行榜 -->
            <div class="home-row-1">
                <div class="card home-card">
                    <h3>近期活动</h3>
                    <div id="home-activities-list" class="home-card-content">加载中...</div>
                </div>

                <div class="card home-card">
                    <h3>最新诗作</h3>
                    <div id="latest-poems-list" class="home-card-content">加载中...</div>
                </div>

                <div class="card home-card">
                    <h3 id="points-ranking-title">年度排行榜</h3>
                    <div id="points-ranking-list" class="home-card-content">加载中...</div>
                </div>
            </div>

            <!-- 第二行：今日推荐 + 摆龙门阵（PC端并排，移动端堆叠） -->
            <div class="home-row-2">
                <div class="card home-daily-card">
                    <h3>今日推荐</h3>
                    <div id="daily-poem">加载中...</div>
                </div>
                <div class="card home-chat-card">
                    <h3>摆龙门阵 <span id="home-chat-user-count" style="font-size:0.8em; color:#888;"></span></h3>
                    <div id="home-chat-preview" class="home-card-content home-chat-messages">
                        <div class="empty-hint">暂无消息，快来说点什么吧</div>
                    </div>
                    <div class="home-chat-input-area">
                        <div style="display:flex; gap:8px; align-items:flex-end;">
                            <textarea id="home-chat-input" placeholder="输入消息..." maxlength="1024" rows="1" style="flex:1; margin:0; padding:8px 12px; resize:none; font-family:inherit; font-size:inherit;" oninput="updateHomeChatSendBtn()" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendHomeChatMessage();}"></textarea>
                            <button id="home-chat-send-btn" onclick="sendHomeChatMessage()" disabled style="padding:8px 16px; margin:0;">发送</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Chat Section -->
        <section id="chat" class="hidden">
            <h2>摆龙门阵</h2>
            <div class="chat-container">
                <div class="chat-main">
                    <div class="card chat-messages-card">
                        <div id="chat-messages" class="chat-messages-list">
                            <div class="empty-hint">暂无消息，快来说点什么吧！</div>
                        </div>
                        <div class="chat-input-area">
                            <div class="chat-input-wrapper">
                                <textarea id="chat-input" placeholder="输入消息（最多1024字）" maxlength="1024" rows="2" oninput="updateChatSendBtn()"></textarea>
                                <div class="chat-input-info">
                                    <span id="chat-char-count">0/1024</span>
                                    <button id="chat-send-btn" onclick="sendChatMessage()" disabled>发送</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chat-sidebar">
                    <div class="card">
                        <h4>在线用户 <span id="chat-online-count">(0)</span></h4>
                        <div id="chat-user-list" class="chat-user-list">
                            <div class="empty-hint">暂无用户</div>
                        </div>
                    </div>
                    <div class="card" style="margin-top:15px;">
                        <h4>龙门阵状态</h4>
                        <div id="chat-status-info" style="font-size:0.85em; color:#666;">
                            <div>内存使用: <span id="chat-memory-usage">-</span></div>
                            <div>消息数量: <span id="chat-msg-count">-</span></div>
                            <div>游客上限: <span id="chat-guest-slots">-</span></div>
                            <div>聊天上限: <span id="chat-max-users">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Admin Section -->
        <section id="admin" class="hidden">
            <h2>后台管理仪表盘</h2>
            <div class="card">
                <h3>设备状态</h3>
                <div class="system-status-grid">
                    <!-- 第1行：文本信息 -->
                    <div class="status-item status-text-item">
                        <span class="status-label">设备</span>
                        <span class="status-value" id="admin-platform">-</span>
                    </div>
                    <div class="status-item status-text-item">
                        <span class="status-label">系统时间</span>
                        <span class="status-value status-time" id="admin-system-time">-</span>
                    </div>
                    <div class="status-item status-text-item">
                        <span class="status-label">系统运行时间</span>
                        <span class="status-value" id="admin-uptime">-</span>
                    </div>
                    <div class="status-grid-divider"></div>
                    <!-- 第2行：存储 + 内存 -->
                    <div class="status-item status-bar-item">
                        <div class="status-bar-header">
                            <span class="status-label">数据存储空间（Flash）</span>
                            <span class="status-text" id="admin-storage-text">-</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-bar-fill" id="admin-storage-bar"></div>
                        </div>
                    </div>
                    <div class="status-item status-bar-item">
                        <div class="status-bar-header">
                            <span class="status-label">运行内存使用</span>
                            <span class="status-text" id="admin-ram-text">-</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-bar-fill" id="admin-ram-bar"></div>
                        </div>
                    </div>
                    <!-- 第3行：温度 + WiFi -->
                    <div class="status-item status-bar-item">
                        <div class="status-bar-header">
                            <span class="status-label">CPU温度</span>
                            <span class="status-text" id="admin-cpu-temp-text">-</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-bar-fill status-bar-temp" id="admin-cpu-temp-bar"></div>
                        </div>
                    </div>
                    <div class="status-item status-bar-item">
                        <div class="status-bar-header">
                            <span class="status-label">WiFi信号</span>
                            <span class="status-text" id="admin-wifi-signal-text">-</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-bar-fill" id="admin-wifi-signal-bar"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card super-admin-only-card" style="margin-top:20px;">
                <h3>缓存统计</h3>
                <div id="cache-stats-container">
                    <div class="cache-stats-summary">
                        <div class="status-item">
                            <span class="status-label">缓存槽总数</span>
                            <span class="status-value" id="cache-slot-count">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">总条目数</span>
                            <span class="status-value" id="cache-total-entries">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">总命中率</span>
                            <span class="status-value" id="cache-total-hit-rate">-</span>
                        </div>
                        <div class="status-item status-bar-item">
                            <div class="status-bar-header">
                                <span class="status-label">已使用内存</span>
                                <span class="status-text" id="cache-memory-text">-</span>
                            </div>
                            <div class="status-bar">
                                <div class="status-bar-fill" id="cache-memory-bar"></div>
                            </div>
                        </div>
                    </div>
                    <div class="cache-detail-table" id="cache-detail-list"></div>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3>数据统计</h3>
                <div class="stats-grid" id="admin-data-stats">
                    <div class="stat-card">
                        <span class="stat-icon flat-icon icon-members"></span>
                        <div class="stat-info">
                            <span class="stat-value" id="stat-members">-</span>
                            <span class="stat-name">社员</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon flat-icon icon-poems"></span>
                        <div class="stat-info">
                            <span class="stat-value" id="stat-poems">-</span>
                            <span class="stat-name">诗作</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon flat-icon icon-activities"></span>
                        <div class="stat-info">
                            <span class="stat-value" id="stat-activities">-</span>
                            <span class="stat-name">活动</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon flat-icon icon-tasks"></span>
                        <div class="stat-info">
                            <span class="stat-value" id="stat-tasks">-</span>
                            <span class="stat-name">事务</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon flat-icon icon-finance"></span>
                        <div class="stat-info">
                            <span class="stat-value" id="stat-finance">-</span>
                            <span class="stat-name">财务记录</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3>用户权限说明</h3>
                <div class="role-permissions-grid">
                    <div class="role-card">
                        <div class="role-header" style="background: linear-gradient(135deg, #004d4d, #003d3d);">
                            <span class="role-title">超级管理员</span>
                        </div>
                        <ul class="role-perms">
                            <li>具有系统所有权限</li>
                            <li>Salt与登录有效期设置</li>
                            <li>WiFi与AP配置管理</li>
                            <li>数据备份与恢复</li>
                            <li>管理所有用户与密码</li>
                        </ul>
                    </div>
                    <div class="role-card">
                        <div class="role-header" style="background: linear-gradient(135deg, #006666, #005555);">
                            <span class="role-title">管理员</span>
                        </div>
                        <ul class="role-perms">
                            <li>超管外所有权限</li>
                            <li>管理理事及以下角色</li>
                            <li>WiFi与AP配置管理</li>
                            <li>成员删除与财务记账</li>
                            <li class="perm-deny">不可管理超级管理员</li>
                        </ul>
                    </div>
                    <div class="role-card">
                        <div class="role-header" style="background: linear-gradient(135deg, #008080, #007070);">
                            <span class="role-title">理事</span>
                        </div>
                        <ul class="role-perms">
                            <li>发起活动与事务</li>
                            <li>管理普通社员</li>
                            <li>审批任务与系统设置</li>
                            <li class="perm-deny">不可改Salt/WiFi</li>
                            <li class="perm-deny">不可管理管理员及以上</li>
                        </ul>
                    </div>
                    <div class="role-card">
                        <div class="role-header" style="background: linear-gradient(135deg, #33a3a3, #2d9090);">
                            <span class="role-title">财务</span>
                        </div>
                        <ul class="role-perms">
                            <li>普通社员权限</li>
                            <li>财务记账操作</li>
                            <li>收支明细管理</li>
                            <li class="perm-deny">无成员管理权限</li>
                            <li class="perm-deny">无活动与事务管理权限</li>
                        </ul>
                    </div>
                    <div class="role-card">
                        <div class="role-header" style="background: linear-gradient(135deg, #66c2c2, #55b0b0);">
                            <span class="role-title">普通社员</span>
                        </div>
                        <ul class="role-perms">
                            <li>查看诗社活动</li>
                            <li>发布诗词作品</li>
                            <li>认领事务任务</li>
                            <li>查看财务公示</li>
                            <li>管理个人资料</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="card director-only-card" style="margin-top:20px;">
                <h3>系统基础设置</h3>
                
                <!-- 基础信息分组 -->
                <div class="settings-group">
                    <div class="settings-group-title">基础信息</div>
                    <div style="margin-bottom:15px;">
                        <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">系统名称</label>
                        <div class="admin-field-row">
                            <input type="text" id="setting-system-name" placeholder="围炉诗社·理事台" style="flex:1;">
                            <button onclick="saveSystemName()">保存</button>
                        </div>
                    </div>
                    <div>
                        <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">积分名称</label>
                        <div class="admin-field-row">
                            <input type="text" id="setting-points-name" placeholder="围炉值" style="flex:1;">
                            <button onclick="savePointsName()">保存</button>
                        </div>
                    </div>
                </div>
                
                <!-- 功能开关分组 -->
                <div class="settings-group">
                    <div class="settings-group-title">功能开关</div>
                    
                    <div class="switch-row">
                        <div class="switch-info">
                            <div class="switch-title">开启网站访问</div>
                            <div class="switch-desc">关闭后其他用户显示维护提示，仅管理员可访问</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-site-open" onchange="saveSiteSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="switch-row">
                        <div class="switch-info">
                            <div class="switch-title">允许游客访问</div>
                            <div class="switch-desc">关闭后只允许社员及以上用户登录访问网站</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-allow-guest" onchange="saveSiteSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="switch-row">
                        <div class="switch-info">
                            <div class="switch-title">摆龙门阵功能</div>
                            <div class="switch-desc">关闭后用户将无法进入摆龙门阵</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-chat-enabled" onchange="saveSiteSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div style="margin-top:12px;">
                        <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">龙门阵游客上限</label>
                        <div class="admin-field-row">
                            <input type="number" id="setting-chat-guest-max" min="0" max="10" placeholder="10" style="flex:1;">
                            <button onclick="saveSiteSettings()">保存</button>
                        </div>
                        <p style="font-size:0.75em; color:#888; margin-top:6px;">允许游客参与人数，范围0-10人，0表示禁止游客</p>
                    </div>
                    
                    <div style="margin-top:12px;">
                        <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">龙门阵人数上限</label>
                        <div class="admin-field-row">
                            <input type="number" id="setting-chat-max-users" min="5" max="100" placeholder="20" style="flex:1;">
                            <button onclick="saveSiteSettings()">保存</button>
                        </div>
                        <p style="font-size:0.75em; color:#888; margin-top:6px;">限制同时在线人数，范围5-100人，默认20人</p>
                    </div>
                    
                    <div style="margin-top:12px;">
                        <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">聊天室缓存大小 (KB)</label>
                        <div class="admin-field-row">
                            <input type="number" id="setting-chat-cache-size" min="16" max="1024" placeholder="128" style="flex:1;">
                            <button onclick="saveSiteSettings()">保存</button>
                        </div>
                        <p style="font-size:0.75em; color:#888; margin-top:6px;">消息缓存占用内存，范围16-1024KB，默认128KB</p>
                    </div>
                </div>
            </div>

            <div class="card admin-only-card" style="margin-top:20px;">
                <h3>WiFi 设置</h3>
                <p style="color:#666; font-size:0.85em; margin-bottom:15px;">配置设备网络连接，支持STA客户端模式和AP热点模式。</p>
                
                <!-- STA模式 -->
                <div style="margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid #eee;">
                    <h4 style="font-size:0.95em; color:#333; margin-bottom:15px; display:flex; align-items:center;">
                        <span id="wifi-mode-sta-badge" style="background:#6c757d; color:#fff; width:20px; height:20px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:0.75em; margin-right:8px;">1</span>
                        STA模式（连接WiFi）
                    </h4>
                    <div class="wifi-form-grid" style="margin-bottom:15px;">
                        <div>
                            <label style="display:block; font-size:0.85em; color:#666; margin-bottom:4px;">WiFi名称 (SSID)</label>
                            <input type="text" id="wifi-ssid" placeholder="输入WiFi名称" style="width:100%;">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.85em; color:#666; margin-bottom:4px;">WiFi密码</label>
                            <input type="password" id="wifi-password" placeholder="输入WiFi密码" style="width:100%;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom:12px;">
                        <label style="display:block; font-size:0.85em; color:#666; margin-bottom:10px;">IP地址获取方式</label>
                        <div class="ip-mode-selector">
                            <label class="ip-mode-option">
                                <input type="radio" name="wifi-ip-mode" value="dhcp" checked onchange="toggleStaticIpFields()">
                                <span class="ip-mode-label">
                                    <span class="ip-mode-title">自动获取</span>
                                    <span class="ip-mode-desc">DHCP</span>
                                </span>
                            </label>
                            <label class="ip-mode-option">
                                <input type="radio" name="wifi-ip-mode" value="static" onchange="toggleStaticIpFields()">
                                <span class="ip-mode-label">
                                    <span class="ip-mode-title">静态IP</span>
                                    <span class="ip-mode-desc">手动配置</span>
                                </span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="static-ip-fields" class="hidden" style="padding:15px; background:#f8f9fa; border-radius:8px; margin-top:10px;">
                        <div class="wifi-form-grid">
                            <div>
                                <label style="display:block; font-size:0.8em; color:#666; margin-bottom:4px;">IP地址</label>
                                <input type="text" id="wifi-sta-ip" placeholder="192.168.1.100" style="width:100%;">
                            </div>
                            <div>
                                <label style="display:block; font-size:0.8em; color:#666; margin-bottom:4px;">子网掩码</label>
                                <input type="text" id="wifi-sta-subnet" placeholder="255.255.255.0" style="width:100%;">
                            </div>
                            <div>
                                <label style="display:block; font-size:0.8em; color:#666; margin-bottom:4px;">网关</label>
                                <input type="text" id="wifi-sta-gateway" placeholder="192.168.1.1" style="width:100%;">
                            </div>
                            <div>
                                <label style="display:block; font-size:0.8em; color:#666; margin-bottom:4px;">DNS服务器</label>
                                <input type="text" id="wifi-sta-dns" placeholder="8.8.8.8" style="width:100%;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AP模式 -->
                <div style="margin-bottom:20px;">
                    <h4 style="font-size:0.95em; color:#333; margin-bottom:15px; display:flex; align-items:center;">
                        <span id="wifi-mode-ap-badge" style="background:#6c757d; color:#fff; width:20px; height:20px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:0.75em; margin-right:8px;">2</span>
                        AP模式（热点）
                    </h4>
                    <p style="font-size:0.8em; color:#888; margin-bottom:12px;">WiFi连接失败时自动启用，用于首次配置或应急访问</p>
                    <div class="wifi-form-grid" style="margin-bottom:12px;">
                        <div>
                            <label style="display:block; font-size:0.85em; color:#666; margin-bottom:4px;">热点名称</label>
                            <input type="text" id="wifi-ap-ssid" placeholder="围炉诗社小热点" style="width:100%;">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.85em; color:#666; margin-bottom:4px;">热点密码</label>
                            <input type="password" id="wifi-ap-password" placeholder="设置热点密码" style="width:100%;">
                        </div>
                    </div>
                    <div>
                        <label style="display:block; font-size:0.85em; color:#666; margin-bottom:4px;">AP模式IP地址</label>
                        <input type="text" id="wifi-ap-ip" placeholder="192.168.1.68" class="wifi-ap-ip-input">
                        <p style="font-size:0.75em; color:#999; margin-top:4px;">连接热点后，访问此IP进入系统后台</p>
                    </div>
                </div>
                
                <div style="display:flex; gap:10px; justify-content:flex-end; padding-top:15px; border-top:1px solid #eee;">
                    <button onclick="loadWifiConfig()" style="background:#6c757d;">刷新配置</button>
                    <button onclick="saveWifiConfig()">保存配置</button>
                </div>
                <p style="font-size:0.8em; color:#e67e22; margin-top:12px; text-align:center;">提示：WiFi配置修改后需要重启设备才能生效</p>
            </div>

            <div class="card director-only-card" style="margin-top:20px;" id="admin-custom-fields">
                <h3>社员资料自定义字段管理</h3>
                <p style="color:#666; font-size:0.85em; margin-bottom:15px;">定义社员的额外资料字段，填写后将显示在社员编辑表单中。</p>
                <div id="settings-fields-list" class="custom-fields-list">Loading...</div>
                <div class="custom-field-add">
                    <input type="text" id="new-field-label" placeholder="字段名称 (如: 微信号)" maxlength="10">
                    <select id="new-field-type">
                        <option value="text">文本</option>
                        <option value="number">数字</option>
                        <option value="date">日期</option>
                        <option value="email">邮箱</option>
                        <option value="textarea">多行文本</option>
                    </select>
                    <div class="required-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" id="new-field-required">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="required-switch-label">必填</span>
                    </div>
                    <button onclick="addCustomFieldInput()">添加</button>
                </div>
            </div>

            <div class="card director-only-card" style="margin-top:20px;">
                <h3>登录日志</h3>
                <p style="color:#666; font-size:0.9em;">最近20条登录记录</p>
                <div id="login-logs-list" class="login-logs-container">加载中...</div>
            </div>

            <div class="card super-admin-only-card" style="margin-top:20px;">
                <h3>安全设置</h3>
                <div>
                    <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">密码加盐值 (Salt)</label>
                    <div class="admin-field-row">
                        <input type="text" id="setting-password-salt" placeholder="输入密码加盐值" style="flex:1;">
                        <button onclick="savePasswordSalt()" style="background:#e67e22;">保存</button>
                    </div>
                    <p style="font-size:0.8em; color:#e74c3c; margin-top:8px;">注意：修改Salt后所有现有密码将失效，需要重置！</p>
                </div>
                <div style="margin-top:20px;">
                    <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">登录有效期 (天)</label>
                    <div class="admin-field-row">
                        <input type="number" id="setting-token-expire-days" min="1" max="365" placeholder="30" style="flex:1;">
                        <button onclick="saveTokenExpireDays()" style="background:#e67e22;">保存</button>
                    </div>
                    <p style="font-size:0.8em; color:#666; margin-top:8px;">设置用户登录后的会话有效期，范围1-365天，默认30天。</p>
                </div>
            </div>

            <div class="card super-admin-only-card" style="margin-top:20px;">
                <h3>数据备份</h3>
                <p style="color:#666; font-size:0.85em; margin-bottom:15px;">导出或导入全站数据备份，用于数据迁移或灾难恢复。</p>
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:200px;">
                        <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">导出数据</label>
                        <button onclick="exportBackup()" style="width:100%; background:var(--accent);">下载备份文件</button>
                    </div>
                    <div style="flex:1; min-width:200px;">
                        <label style="display:block; font-size:0.85em; color:#666; margin-bottom:6px;">导入数据</label>
                        <input type="file" id="backup-file-input" accept=".json" style="display:none;" onchange="importBackup(event)">
                        <button onclick="document.getElementById('backup-file-input').click()" style="width:100%; background:#e67e22;">选择备份文件</button>
                    </div>
                </div>
                <p style="font-size:0.8em; color:#e74c3c; margin-top:12px;">警告：导入数据将覆盖现有数据，请谨慎操作！</p>
            </div>
        </section>

        <!-- Poems Section -->
        <section id="poems" class="hidden">
            <div class="header-row">
                <h2>藏诗阁</h2>
                <button id="btn-add-poem" onclick="openPoemModal()" class="hidden">撰写新作品</button>
            </div>
            
            <div id="poem-list"></div>
            
            <button id="poem-load-more" class="load-more-btn hidden" onclick="fetchPoems(true)">查看更多作品</button>
        </section>

        <!-- Activities Section -->
        <section id="activities" class="hidden">
            <div class="header-row">
                <h2>诗社活动</h2>
                <button onclick="openActivityModal()" id="btn-add-activity" class="hidden">发起活动</button>
            </div>
            <div id="activity-list"></div>
            <button id="activity-load-more" class="load-more-btn hidden" onclick="fetchActivities(true)">查看更多活动</button>
        </section>

        <!-- Finance Section -->
        <section id="finance" class="hidden">
            <div class="header-row">
                <h2>财务公示</h2>
                <button onclick="openFinanceModal()" id="btn-add-finance" class="hidden">记一笔</button>
            </div>
            <div class="card finance-stats">
                <div class="finance-balance">
                    <h4>当前余额</h4>
                    <span id="balance" class="balance-value">0</span>
                </div>
                <div class="finance-details">
                    <div class="stat-item">
                        <h4>本年度总收入</h4>
                        <span id="total-income" class="money plus">0</span>
                    </div>
                    <div class="stat-item">
                        <h4>本年度总支出</h4>
                        <span id="total-expense" class="money minus">0</span>
                    </div>
                </div>
            </div>
            <table class="table">
                <thead><tr><th>日期</th><th>摘要</th><th>金额</th><th>经办</th><th id="finance-op-th" class="hidden">操作</th></tr></thead>
                <tbody id="finance-list"></tbody>
            </table>
            <button id="finance-load-more" class="load-more-btn hidden" onclick="fetchFinance(true)">查看更多记录</button>
        </section>

        <!-- Tasks Section -->
        <section id="tasks" class="hidden">
            <div class="header-row">
                <h2 id="tasks-section-title">事务与积分</h2>
                <button onclick="openTaskModal()" id="btn-add-task" class="hidden">发布事务</button>
            </div>
            <div id="task-list"></div>
            <button id="task-load-more" class="load-more-btn hidden" onclick="fetchTasks(true)">查看更多事务</button>
        </section>

        <!-- Members Section -->
        <section id="members" class="hidden">
            <div class="header-row">
                <h2>社员名录</h2>
                <button onclick="openMemberModal()" id="btn-add-member" class="hidden">录入社员</button>
            </div>
            <div id="member-list" class="grid"></div>
            <button id="member-load-more" class="load-more-btn hidden" onclick="fetchMembers(true)">查看更多社员</button>
        </section>
    </main>

    <!-- Modals -->
    <div id="modal-poem" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-poem')"></span>
            <h3>发布新作</h3>
            <input type="text" id="p-title" placeholder="诗名/标题 *">
            <textarea id="p-content" placeholder="正文 *" rows="6"></textarea>
            <select id="p-type">
                <option>古体诗</option>
                <option>绝句</option>
                <option>律诗</option>
                <option>排律</option>
                <option>词</option>
                <option>现代诗</option>
                <option>文章</option>
                <option>其它</option>
            </select>
            <label for="p-date" class="date-label">发布时间</label>
            <input type="datetime-local" id="p-date">
            
            <div id="poem-modal-actions" style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <!-- Buttons injected by JS -->
            </div>
        </div>
    </div>

    <!-- Read-Only Poem Detail Modal -->
    <div id="modal-poem-view" class="modal hidden">
        <div class="modal-content" style="max-width:700px;">
            <span class="close" onclick="toggleModal('modal-poem-view')"></span>
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-top:35px; margin-bottom:20px;">
                <h3 id="view-poem-title" style="margin:0; flex:1; padding-right:12px;"></h3>
                <span id="view-poem-type" style="flex-shrink:0;"></span>
            </div>
            <div id="view-poem-container"></div>
            <div id="view-poem-actions" style="margin-top:20px; padding-top:15px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px;"></div>
        </div>
    </div>

    <div id="modal-finance" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-finance')"></span>
            <h3>财务记账</h3>
            <select id="f-type">
                <option value="income">收入</option>
                <option value="expense">支出</option>
            </select>
            <select id="f-category">
                <option value="会费">会费</option>
                <option value="活动费用">活动费用</option>
                <option value="物资采购">物资采购</option>
                <option value="稿费">稿费</option>
                <option value="捐赠">捐赠</option>
                <option value="结转">结转</option>
                <option value="其他">其他</option>
            </select>
            <input type="number" id="f-amount" placeholder="金额 *">
            <input type="text" id="f-summary" placeholder="摘要 *">
            <input type="text" id="f-handler" placeholder="经办人 *">
            <input type="date" id="f-date" placeholder="记账日期 *">
            <button onclick="submitFinance()">提交</button>
        </div>
    </div>

    <div id="modal-task" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-task')"></span>
            <h3 id="task-modal-title">发布事务</h3>
            <input type="text" id="t-title" placeholder="事务标题 *">
            <textarea id="t-description" placeholder="事务描述" rows="6"></textarea>
            <input type="number" id="t-reward" placeholder="奖励积分" min="0">
            <select id="t-assignee" style="width:100%;">
                <option value="">指派给（可选）</option>
            </select>
            <div id="task-modal-actions" style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button onclick="submitTask()">发布</button>
            </div>
        </div>
    </div>

    <div id="modal-member" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-member')"></span>
            <h3>录入新社员</h3>
            <input type="text" id="m-name" placeholder="姓名 *">
            <input type="text" id="m-alias" placeholder="雅号/花名">
            <input type="text" id="m-phone" placeholder="手机号 *">
            <input type="password" id="m-password" placeholder="初始密码 *">
            <select id="m-role">
                <option value="member">普通社员</option>
                <option value="director">理事</option>
                <option value="finance">财务</option>
                <option value="admin">管理员</option>
                <option value="super_admin">超级管理员</option>
            </select>
            <input type="number" id="m-points" placeholder="初始积分 (默认0)">
            <label for="m-birthday" class="date-label">生日</label>
            <input type="date" id="m-birthday">
            <div id="m-custom-fields-container" style="margin: 10px 0; border-top: 1px solid #eee; padding-top: 10px;"></div>
            <button onclick="submitMember()">保存</button>
        </div>
    </div>

    <div id="modal-profile" class="modal hidden">
        <div class="modal-content" style="max-width:450px;">
            <span class="close" onclick="toggleModal('modal-profile')"></span>
            <h3 style="margin-top:25px;">个人中心</h3>
            
            <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="width:50px; height:50px; background:var(--accent); color:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5em;" id="profile-avatar">👤</div>
                    <div>
                        <div style="font-weight:600; font-size:1.1em;" id="profile-display-name">-</div>
                        <div style="color:#666; font-size:0.85em;" id="profile-role">-</div>
                    </div>
                </div>
            </div>
            
            <input type="text" id="profile-alias" placeholder="雅号">
            <label for="profile-birthday" class="date-label">生日</label>
            <input type="date" id="profile-birthday">
            <button onclick="saveProfile()" style="width:100%;">保存资料</button>
            
            <div style="border-top:1px solid #eee; padding-top:15px; margin-top:15px;">
                <h4 style="font-size:0.95em; color:#333; margin-bottom:12px;">修改密码</h4>
                <input type="password" id="profile-old-password" placeholder="原密码 *">
                <input type="password" id="profile-new-password" placeholder="新密码 *">
                <input type="password" id="profile-confirm-password" placeholder="确认新密码 *">
                <button onclick="submitProfilePassword()" style="width:100%; background:#6c757d;">修改密码</button>
            </div>
        </div>
    </div>

    <div id="modal-activity" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-activity')"></span>
            <h3>发起活动</h3>
            <input type="text" id="act-title" placeholder="活动主题 *">
            <textarea id="act-desc" placeholder="活动详情/说明" rows="6"></textarea>
            <label for="act-date" class="date-label">活动时间 *</label>
            <input type="datetime-local" id="act-date">
            <input type="text" id="act-location" placeholder="活动地点">
            <select id="act-status">
                <option value="筹备中">筹备中</option>
                <option value="报名中">报名中</option>
                <option value="进行中">进行中</option>
                <option value="已结束">已结束</option>
            </select>
            <button onclick="submitActivity()">发布</button>
        </div>
    </div>

    <!-- Read-Only Activity Detail Modal -->
    <div id="modal-activity-view" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="toggleModal('modal-activity-view')"></span>
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-top:35px; margin-bottom:20px;">
                <h3 id="view-act-title" style="margin:0; padding:0; flex:1; padding-right:12px;"></h3>
                <span id="view-act-status" class="points-badge" style="flex-shrink:0; margin:0;"></span>
            </div>
            <!-- Combined Info Area -->
            <div id="view-act-container" style="color:#444;"></div>
            
            <div id="view-act-actions" style="margin-top:20px; padding-top:15px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px;"></div>
        </div>
    </div>
    
    <!-- Backup Progress Modal -->
    <div id="modal-backup-progress" class="modal hidden" style="z-index:10000;">
        <div class="modal-content" style="max-width:360px; margin:auto; padding:20px 25px;">
            <h3 id="backup-progress-title" style="margin:0 0 15px 0; font-size:1.1em;">数据备份中...</h3>
            <div style="margin-bottom:12px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:0.9em;">
                    <span id="backup-progress-status">准备中...</span>
                    <span id="backup-progress-percent">0%</span>
                </div>
                <div style="background:#e0e0e0; border-radius:4px; height:16px; overflow:hidden;">
                    <div id="backup-progress-bar" style="background:var(--accent); height:100%; width:0%; transition:width 0.3s;"></div>
                </div>
            </div>
            <p id="backup-progress-detail" style="font-size:0.8em; color:#888; margin:0;">正在处理...</p>
        </div>
    </div>
    
    </div> <!-- Close main-app div -->
    <footer class="site-footer">
        <p>&copy; <span id="footer-year"></span> <span id="footer-site-name"></span></p>
    </footer>
    <script src="/static/marked.umd.js"></script>
    <script src="/static/purify.min.js"></script>
    <script src="/static/app.js"></script>
    <script>
        document.getElementById('footer-year').textContent = new Date().getFullYear();
    </script>
</body>
</html>
