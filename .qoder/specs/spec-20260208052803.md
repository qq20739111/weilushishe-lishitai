# 全站表单提交防重复提交机制修复计划

## 问题概述
前端多个表单提交操作缺少按钮禁用机制，用户快速点击可能导致重复提交。需要为所有涉及网络请求的提交操作添加防重复提交保护。

## 修改文件
- `/src/static/app.js`
- `/src/static/index.html`（按钮调用方式调整）

## 需修复的函数清单（共 20 个）

### P1 - 高优先级（核心业务流程）- 10 个

| # | 函数名 | 行号 | 按钮位置 | 加载文案 |
|---|--------|------|----------|----------|
| 1 | `publishPoem()` | ~988 | app.js:935,956 动态生成 | 发布中... |
| 2 | `submitPoemUpdate()` | ~1024 | app.js:940 动态生成 | 更新中... |
| 3 | `withdrawPoem()` | ~1048 | app.js:941 动态生成 | 撤回中... |
| 4 | `submitTask()` | ~1743 | index.html:679 `#modal-task button` | 提交中... |
| 5 | `claimTask(taskId)` | ~1812 | 动态生成 .btn-claim | 领取中... |
| 6 | `submitTaskComplete(taskId)` | ~1856 | app.js:1629 动态生成 | 提交中... |
| 7 | `approveTask(taskId)` | ~1878 | 动态生成 .btn-approve | 验收中... |
| 8 | `forceApproveTask(taskId)` | ~1913 | 动态生成 | 验收中... |
| 9 | `rejectTask(taskId)` | ~1941 | 动态生成 .btn-reject | 退回中... |
| 10 | `completeTask(taskId)` | ~1985 | 动态生成 | 完成中... |

### P2 - 中优先级（删除和资料操作）- 7 个

| # | 函数名 | 行号 | 按钮位置 | 加载文案 |
|---|--------|------|----------|----------|
| 11 | `deleteActivity(id)` | ~2142 | 动态生成 | 删除中... |
| 12 | `deletePoemWrapper(id, isLocal)` | ~1086 | 动态生成 | 删除中... |
| 13 | `deleteMember(id)` | ~1482 | 动态生成 .btn-remove | 删除中... |
| 14 | `saveProfile()` | ~518 | index.html:725 | 保存中... |
| 15 | `submitProfilePassword()` | ~566 | index.html:732 | 修改中... |
| 16 | `unclaimTask(taskId)` | ~1834 | 动态生成 | 撤销中... |
| 17 | `deleteTask(taskId)` | ~1963 | 动态生成 .btn-delete | 删除中... |

### P3 - 低优先级（系统设置、备份）- 3 个

| # | 函数名 | 行号 | 说明 |
|---|--------|------|------|
| 18 | `exportBackup()` | ~3229 | 导出备份 |
| 19 | `importBackup()` | ~3344 | 已有进度条，需禁用触发按钮 |
| 20 | `triggerImportBackup()` | ~3340 | 触发导入 |

## 实施方案

### 方案A：使用 event.target 获取按钮（推荐）
对于动态生成的按钮（onclick 内联调用），通过传递 event 参数获取按钮：

**HTML 调整示例**:
```javascript
// 修改前
onclick="claimTask(${t.id})"

// 修改后
onclick="claimTask(${t.id}, event)"
```

**JS 函数调整示例**:
```javascript
async function claimTask(taskId, event) {
    const btn = event?.target;
    if (btn) {
        btn.disabled = true;
        btn.innerText = '领取中...';
    }
    // ... 原有逻辑
    if (btn) {
        btn.disabled = false;
        btn.innerText = '领取';
    }
}
```

### 方案B：模态框内按钮使用选择器
对于模态框内的固定按钮，直接用选择器：

```javascript
async function submitTask() {
    const btn = document.querySelector('#modal-task button');
    const oldText = btn.innerText;
    btn.innerText = '提交中...';
    btn.disabled = true;
    try {
        // 原有逻辑
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}
```

## 详细修改清单

### 1. 藏诗阁模块 (app.js)

**publishPoem() ~988行**:
- 获取按钮: 从 `openPoemModal()` 动态生成的 footer 中定位
- 方案: 在函数开头获取 `#modal-poem .modal-footer button` 第一个按钮

**submitPoemUpdate() ~1024行**:
- 获取按钮: 动态生成的"更新作品"按钮
- 方案: 同上，或使用 event 传递

**withdrawPoem() ~1048行**:
- 获取按钮: 动态生成的"从藏诗阁撤回"按钮
- 方案: 使用 event 传递

**deletePoemWrapper() ~1086行**:
- 添加 event 参数，confirm 后禁用按钮

### 2. 事务模块 (app.js)

**submitTask() ~1743行**:
- 按钮选择器: `#modal-task button`
- 添加标准防护模式

**claimTask/unclaimTask/submitTaskComplete/approveTask/forceApproveTask/rejectTask/deleteTask/completeTask**:
- 添加 event 参数
- 修改所有 onclick 调用，传递 event
- 在函数内部实现按钮禁用

### 3. 活动模块 (app.js)

**deleteActivity() ~2142行**:
- 添加 event 参数
- 修改 onclick 调用

### 4. 社员模块 (app.js)

**deleteMember() ~1482行**:
- 添加 event 参数
- 修改 onclick 调用

### 5. 个人资料 (index.html + app.js)

**saveProfile() ~518行**:
- 按钮在 index.html:725
- 添加标准防护模式

**submitProfilePassword() ~566行**:
- 按钮在 index.html:732
- 添加标准防护模式

### 6. 备份模块 (app.js)

**exportBackup() ~3229行**:
- 在导出期间禁用导出按钮

**importBackup() ~3344行**:
- 在 showBackupProgress 后禁用导入触发按钮
- 在 hideBackupProgress 前恢复

## 实施步骤

1. **步骤1**: 修改藏诗阁模块 (publishPoem, submitPoemUpdate, withdrawPoem, deletePoemWrapper)
2. **步骤2**: 修改事务模块 (submitTask + 8个任务操作函数)
3. **步骤3**: 修改活动模块 (deleteActivity)
4. **步骤4**: 修改社员模块 (deleteMember)
5. **步骤5**: 修改个人资料 (saveProfile, submitProfilePassword)
6. **步骤6**: 修改备份模块 (exportBackup, importBackup)

## 验证方法

1. 在浏览器中打开应用 (http://localhost 或设备 IP)
2. 对每个修复的功能进行测试：
   - 点击提交按钮，观察是否立即禁用
   - 观察按钮文案是否变为对应的"处理中..."
   - 请求完成后按钮是否恢复正常
3. 使用浏览器开发者工具模拟慢速网络，测试重复点击防护效果
4. 检查控制台无 JavaScript 错误
