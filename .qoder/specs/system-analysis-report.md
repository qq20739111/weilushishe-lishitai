# 围炉诗社·理事台 系统分析与优化计划

## 项目概况
- **项目名称**: 围炉诗社·理事台 (Weilushishe Lishitai)
- **版本**: v1.0.0
- **代码规模**: 后端 ~6,600行，前端 ~3,800行，API 39个

## 问题分类汇总

| 优先级 | 问题数 | 类型 |
|--------|--------|------|
| P0 高 | 5 | 安全/稳定性 |
| P1 中 | 7 | 功能/规范 |
| P2 低 | 4 | 优化/体验 |

---

## P0 高优先级修复 (必须修复)

### 1. boot.py 双重启动代码冗余
- **位置**: `src/boot.py:164`
- **问题**: `main.app.run(port=80) or main.app.run(port=80)` 逻辑错误
- **修复**: 删除冗余的 `or main.app.run(port=80)`

### 2. 过于宽泛的异常处理
- **位置**: `src/main.py:39-41, 148, 216`
- **问题**: `except: pass` 会隐藏关键错误
- **修复**: 改为 `except Exception as e: debug(f"错误: {e}", "模块")`

### 3. Members和Tasks API缺少分页
- **位置**: `src/main.py:740-750 (members), 900-910 (tasks)`
- **问题**: 使用 `get_all()` 一次性加载，数据量大时内存溢出
- **修复**: 改用 `fetch_page(page, limit)` 实现分页

### 4. 删除成员函数无错误处理
- **位置**: `src/static/app.js:830-836`
- **问题**: `deleteMember()` 未检查响应状态
- **修复**: 添加响应状态检查和错误提示

### 5. localStorage键名不一致
- **位置**: `src/static/app.js:147, 214`
- **问题**: 混用 `'user'` 和 `'currentUser'` 键名
- **修复**: 统一使用 `'user'` 键名

---

## P1 中优先级修复 (功能完善)

### 1. Finance模块缺少Update/Delete API
- **位置**: `src/main.py` (需新增)
- **问题**: 财务记录创建后无法修改或删除
- **修复**: 新增 `/api/finance/update` 和 `/api/finance/delete` 接口

### 2. 错误响应格式不统一
- **位置**: `src/main.py` 多处
- **问题**: 存在3种不同错误返回格式
- **修复**: 统一为 `{"success": false, "error": {...}}` 格式

### 3. 分页API响应缺少元信息
- **位置**: `src/main.py:151-223`
- **问题**: 仅返回数据数组，缺少total/total_pages
- **修复**: 返回 `{"data": [...], "pagination": {...}}` 格式

### 4. 前端代码缺少中文注释
- **位置**: `src/static/app.js` 全文件
- **问题**: 几乎无函数注释，违反规范
- **修复**: 为关键函数添加中文注释

### 5. 全局搜索Tasks未使用服务端API
- **位置**: `src/static/app.js:1762-1765`
- **问题**: Tasks使用客户端过滤而非服务端搜索
- **修复**: 统一使用服务端搜索 `?q=xxx`

### 6. 模态框交互增强
- **位置**: `src/static/app.js:326-329`
- **问题**: 缺少ESC关闭、遮罩点击关闭
- **修复**: 增强toggleModal函数功能

### 7. 表单验证不完善
- **位置**: `src/static/app.js` 多处表单
- **问题**: 部分表单缺少输入验证
- **修复**: 添加必填、格式、范围验证

---

## P2 低优先级优化 (体验提升)

### 1. 系统监控信息不足
- **位置**: `/api/system/info`
- **问题**: 缺少uptime、WiFi信号强度
- **修复**: 添加系统运行时间和RSSI显示

### 2. 数据模型字符串引用
- **位置**: 多个JSONL数据文件
- **问题**: author/publisher/assignee使用字符串而非ID
- **修复**: 改为ID引用 + 名称快照

### 3. API响应缓存
- **位置**: `src/main.py`
- **问题**: 静态数据每次请求都读取
- **修复**: 添加简单内存缓存(10秒过期)

### 4. LED自动关闭状态管理
- **位置**: `src/lib/SystemStatus.py:122-130`
- **问题**: 空闲后flash_once可能不执行
- **修复**: 在flash_once中检测并恢复LED状态

---

## 修改文件清单

| 文件路径 | 修改类型 | 优先级 |
|----------|----------|--------|
| `src/boot.py` | 删除冗余代码 | P0 |
| `src/main.py` | 异常处理/分页/API | P0/P1 |
| `src/static/app.js` | 错误处理/注释/验证 | P0/P1 |
| `src/lib/SystemStatus.py` | LED状态管理 | P2 |

---

## 实施步骤

### 第1步: P0高优先级修复
1. 修复 `boot.py:164` 双重启动代码
2. 改进 `main.py` 异常处理（3处）
3. 为Members和Tasks API添加分页支持
4. 修复 `app.js` deleteMember错误处理
5. 统一 `app.js` localStorage键名

### 第2步: P1中优先级修复
1. 添加Finance Update/Delete API
2. 统一API错误响应格式
3. 添加分页元信息返回
4. 为app.js添加关键函数注释
5. 统一全局搜索使用服务端API
6. 增强模态框交互
7. 完善表单验证

### 第3步: P2低优先级优化
1. 添加系统运行时间统计
2. 改进数据模型引用方式
3. 添加API缓存机制
4. 修复LED状态管理

---

## 验证方案

1. **代码验证**: 运行语法检查确保无错误
2. **功能验证**: 
   - 测试分页API返回格式
   - 测试Finance CRUD操作
   - 测试删除成员错误提示
3. **兼容性验证**: 确保修改不影响现有功能
