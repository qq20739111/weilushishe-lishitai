# 成员实体模型

<cite>
**本文档引用的文件**
- [main.py](file://main.py)
- [boot.py](file://boot.py)
- [index.html](file://static/index.html)
- [app.js](file://static/app.js)
- [members.jsonl](file://data/members.jsonl)
- [settings.json](file://data/settings.json)
- [config.json](file://data/config.json)
- [poems.jsonl](file://data/poems.jsonl)
- [activities.jsonl](file://data/activities.jsonl)
- [finance.jsonl](file://data/finance.jsonl)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介

围炉诗社·理事台项目是一个基于ESP32微控制器的Web应用，用于管理诗社的各项业务。成员实体模型是整个系统的核心数据结构，承载着诗社成员的基本信息、权限管理和积分体系。本文档将深入分析成员实体的完整设计，包括数据结构、角色权限体系、状态管理以及与其他功能模块的关联关系。

## 项目结构

该项目采用前后端分离的架构设计，主要包含以下核心组件：

```mermaid
graph TB
subgraph "前端层"
HTML[HTML页面]
CSS[样式表]
JS[JavaScript逻辑]
end
subgraph "后端层"
MAIN[主应用服务]
DB[JSONL数据库]
ROUTES[路由控制器]
end
subgraph "数据层"
MEMBERS[成员数据]
POEMS[诗歌数据]
ACTIVITIES[活动数据]
FINANCE[财务数据]
SETTINGS[系统设置]
end
HTML --> MAIN
CSS --> MAIN
JS --> MAIN
MAIN --> DB
DB --> MEMBERS
DB --> POEMS
DB --> ACTIVITIES
DB --> FINANCE
DB --> SETTINGS
```

**图表来源**
- [main.py](file://main.py#L261-L266)
- [index.html](file://static/index.html#L1-L269)

**章节来源**
- [main.py](file://main.py#L1-L548)
- [boot.py](file://boot.py#L1-L122)

## 核心组件

### 成员实体数据结构

成员实体采用JSON格式存储，包含以下核心字段：

| 字段名 | 类型 | 必填 | 默认值 | 描述 |
|--------|------|------|--------|------|
| id | 整数 | 是 | 自增 | 成员唯一标识符 |
| phone | 字符串 | 是 | - | 手机号码（登录凭证） |
| name | 字符串 | 是 | - | 成员真实姓名 |
| password | 字符串 | 是 | - | 登录密码 |
| alias | 字符串 | 否 | - | 雅号/花名 |
| role | 字符串 | 否 | "member" | 角色权限 |
| points | 整数 | 否 | 0 | 积分余额 |
| joined_at | 字符串 | 否 | 当前日期 | 加入日期 |
| custom | 对象 | 否 | {} | 自定义字段 |

### 角色权限体系

系统实现了多层次的权限控制机制：

```mermaid
graph TD
SUPER_ADMIN[超级管理员] --> ADMIN[管理员]
ADMIN --> DIRECTOR[理事]
DIRECTOR --> FINANCE[财务人员]
FINANCE --> MEMBER[普通成员]
SUPER_ADMIN --> SUPER_ADMIN_ACCESS[完全访问权限]
ADMIN --> ADMIN_ACCESS[管理权限]
DIRECTOR --> DIRECTOR_ACCESS[活动管理权限]
FINANCE --> FINANCE_ACCESS[财务操作权限]
MEMBER --> MEMBER_ACCESS[基本使用权限]
```

**图表来源**
- [index.html](file://static/index.html#L219-L225)
- [app.js](file://static/app.js#L517-L518)

**章节来源**
- [members.jsonl](file://data/members.jsonl#L1-L4)
- [index.html](file://static/index.html#L219-L225)

## 架构概览

系统采用RESTful API架构，通过HTTP请求与响应进行数据交互：

```mermaid
sequenceDiagram
participant Client as 客户端
participant API as API服务器
participant DB as 数据库
participant Member as 成员模块
Client->>API : GET /api/members
API->>DB : 读取成员数据
DB-->>API : 返回成员列表
API-->>Client : 成员数据
Client->>API : POST /api/members
API->>Member : 验证手机号唯一性
Member->>DB : 写入新成员记录
DB-->>Member : 确认写入成功
Member-->>API : 返回新成员信息
API-->>Client : 成功响应
```

**图表来源**
- [main.py](file://main.py#L451-L483)

**章节来源**
- [main.py](file://main.py#L299-L548)

## 详细组件分析

### 成员数据库管理

系统使用自定义的JsonlDB类来管理成员数据，该类提供了完整的CRUD操作：

```mermaid
classDiagram
class JsonlDB {
+string filepath
+__init__(filepath, auto_migrate)
+_ensure_dir()
+_migrate_legacy_json()
+append(record)
+get_max_id()
+fetch_page(page, limit, reverse, search_term, search_fields)
+update(id_val, update_func)
+delete(id_val)
+get_all()
}
class MemberAPI {
+list_members(request)
+create_member(request)
+update_member_route(request)
+delete_member_route(request)
+login_route(request)
}
JsonlDB <|-- MemberAPI : 使用
```

**图表来源**
- [main.py](file://main.py#L53-L258)
- [main.py](file://main.py#L451-L483)

### 成员权限控制机制

权限控制通过前端JavaScript实现，根据不同角色显示相应的操作按钮：

```mermaid
flowchart TD
Start([用户登录]) --> CheckRole{检查用户角色}
CheckRole --> |超级管理员| SuperAdmin[显示全部操作按钮]
CheckRole --> |管理员| Admin[显示管理相关按钮]
CheckRole --> |理事| Director[显示活动管理按钮]
CheckRole --> |财务人员| Finance[显示财务操作按钮]
CheckRole --> |普通成员| Member[仅显示基础功能]
SuperAdmin --> ShowAll[显示录入社员、发起活动等按钮]
Admin --> ShowManage[显示管理功能按钮]
Director --> ShowActivity[显示活动相关按钮]
Finance --> ShowFinance[显示财务操作按钮]
Member --> ShowBasic[仅显示基础使用功能]
ShowAll --> End([权限生效])
ShowManage --> End
ShowActivity --> End
ShowFinance --> End
ShowBasic --> End
```

**图表来源**
- [app.js](file://static/app.js#L140-L147)
- [app.js](file://static/app.js#L517-L518)

**章节来源**
- [app.js](file://static/app.js#L140-L147)
- [app.js](file://static/app.js#L517-L518)

### 成员状态管理

系统支持成员状态的完整生命周期管理：

```mermaid
stateDiagram-v2
[*] --> Active : 创建成员
Active --> Active : 正常使用
Active --> Frozen : 权限限制
Active --> Deleted : 注销账户
Frozen --> Active : 解冻
Frozen --> Deleted : 强制注销
Deleted --> [*] : 数据清理
note right of Active
可正常登录
可参与活动
可获得积分
end note
note right of Frozen
限制登录权限
无法参与活动
积分冻结
end note
note right of Deleted
数据删除
历史记录保留
end note
```

**图表来源**
- [main.py](file://main.py#L485-L503)

### 成员字段验证规则

系统实现了多层次的数据验证机制：

```mermaid
flowchart TD
Input[成员数据输入] --> ValidatePhone{验证手机号}
ValidatePhone --> |重复| PhoneError[返回错误: 手机号已存在]
ValidatePhone --> |唯一| ValidateName{验证姓名}
ValidateName --> |为空| NameError[返回错误: 姓名不能为空]
ValidateName --> |有效| ValidatePassword{验证密码}
ValidatePassword --> |为空| PasswordError[返回错误: 密码不能为空]
ValidatePassword --> |有效| ValidateRole{验证角色}
ValidateRole --> |无效| RoleError[返回错误: 角色无效]
ValidateRole --> |有效| ValidatePoints{验证积分}
ValidatePoints --> |负数| PointsError[返回错误: 积分不能为负数]
ValidatePoints --> |有效| SaveRecord[保存记录]
PhoneError --> End([验证失败])
NameError --> End
PasswordError --> End
RoleError --> End
PointsError --> End
SaveRecord --> End([验证成功])
```

**图表来源**
- [main.py](file://main.py#L456-L468)

**章节来源**
- [main.py](file://main.py#L456-L468)

### 成员与业务模块关联

成员实体与各个功能模块存在紧密的关联关系：

```mermaid
erDiagram
MEMBER {
integer id PK
string phone UK
string name
string password
string alias
string role
integer points
string joined_at
json custom
}
POEM {
integer id PK
string title
string content
string author FK
string type
datetime date
}
ACTIVITY {
integer id PK
string title
string desc
string location
string date
string status
string publisher FK
}
FINANCE {
integer id PK
string type
float amount
string summary
string handler
string date
}
TASK {
integer id PK
string title
string desc
integer reward
string status
string assignee FK
}
MEMBER ||--o{ POEM : writes
MEMBER ||--o{ ACTIVITY : publishes
MEMBER ||--o{ FINANCE : handles
MEMBER ||--o{ TASK : completes
```

**图表来源**
- [poems.jsonl](file://data/poems.jsonl#L1-L4)
- [activities.jsonl](file://data/activities.jsonl#L1-L7)
- [finance.jsonl](file://data/finance.jsonl#L1-L3)

**章节来源**
- [poems.jsonl](file://data/poems.jsonl#L1-L4)
- [activities.jsonl](file://data/activities.jsonl#L1-L7)
- [finance.jsonl](file://data/finance.jsonl#L1-L3)

## 依赖分析

系统各组件之间的依赖关系如下：

```mermaid
graph TB
subgraph "核心依赖"
MAIN[main.py] --> JSON[json模块]
MAIN --> OS[os模块]
MAIN --> NETWORK[network模块]
MAIN --> TIME[time模块]
MAIN --> GC[gc模块]
end
subgraph "数据库依赖"
MAIN --> JSONL[JsonlDB类]
JSONL --> FILE[文件系统操作]
end
subgraph "网络依赖"
MAIN --> MICRODOT[Microdot框架]
BOOT[boot.py] --> WIFI[WifiConnector]
BOOT --> STATUS[SystemStatus]
end
subgraph "前端依赖"
HTML --> APPJS[app.js]
APPJS --> LOCALSTORAGE[localStorage]
APPJS --> INDEXEDDB[IndexedDB]
end
```

**图表来源**
- [main.py](file://main.py#L1-L16)
- [boot.py](file://boot.py#L1-L12)

**章节来源**
- [main.py](file://main.py#L1-L16)
- [boot.py](file://boot.py#L1-L12)

## 性能考虑

系统在设计时充分考虑了性能优化：

1. **内存优化**: 使用流式文件读取，避免一次性加载大量数据
2. **缓存策略**: 前端使用localStorage缓存用户信息和自定义字段配置
3. **索引机制**: 通过ID字段实现快速查找
4. **分页处理**: API接口支持分页查询，减少单次传输数据量

## 故障排除指南

### 常见问题及解决方案

| 问题类型 | 症状 | 可能原因 | 解决方案 |
|----------|------|----------|----------|
| 登录失败 | 提示账号或密码错误 | 用户名或密码错误 | 检查输入的手机号和密码是否正确 |
| 成员注册失败 | 返回"Phone exists" | 手机号已被注册 | 更换其他手机号进行注册 |
| 权限不足 | 按钮不可见 | 角色权限不够 | 使用更高权限的账号登录 |
| 数据同步问题 | 页面显示异常 | 缓存数据过期 | 清除浏览器缓存或刷新页面 |

**章节来源**
- [main.py](file://main.py#L485-L503)
- [main.py](file://main.py#L461-L468)

## 结论

围炉诗社·理事台项目的成员实体模型设计合理，实现了完整的权限控制和数据管理功能。通过JSONL格式的数据库设计，系统具备良好的扩展性和维护性。角色权限体系清晰明确，能够满足诗社日常管理的各种需求。

系统的前端界面友好，后端API设计规范，为后续的功能扩展奠定了坚实的基础。建议在未来版本中进一步完善数据验证机制和错误处理流程，提升系统的稳定性和用户体验。