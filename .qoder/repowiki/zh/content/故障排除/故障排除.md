# 故障排除

<cite>
**本文引用的文件**
- [boot.py](file://boot.py)
- [main.py](file://main.py)
- [WifiConnector.py](file://lib/WifiConnector.py)
- [SystemStatus.py](file://lib/SystemStatus.py)
- [BreathLED.py](file://lib/BreathLED.py)
- [wifi_connector_example.py](file://lib/wifi_connector_example.py)
- [breath_led_example.py](file://lib/breath_led_example.py)
- [config.json](file://data/config.json)
- [settings.json](file://data/settings.json)
- [index.html](file://static/index.html)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本手册面向“围炉诗社·理事台”项目，提供系统化的故障排除方法，覆盖WiFi连接问题、系统启动故障、网络配置错误、硬件兼容性问题、日志分析与调试工具使用、性能问题定位、紧急恢复与数据修复流程，以及问题报告与反馈机制。内容结合代码结构与实际实现，帮助开发者与运维人员快速定位并解决问题。

## 项目结构
项目采用“引导层 + 应用层 + 系统服务库”的分层组织：
- 引导层：boot.py 负责系统启动、WiFi连接与AP模式切换、LED状态指示、应用入口启动。
- 应用层：main.py 提供Web API与前端静态资源路由，承载业务数据库（JSONL）与系统状态查询。
- 系统服务库：lib/WifiConnector.py 提供WiFi连接、热点、诊断与配置持久化；lib/SystemStatus.py 与 lib/BreathLED.py 提供LED状态指示与呼吸效果。
- 数据与配置：data/ 目录存放各业务JSONL数据与系统配置；static/ 提供前端页面与资源。

```mermaid
graph TB
Boot["引导层<br/>boot.py"] --> Main["应用层<br/>main.py"]
Boot --> Wifi["WiFi服务<br/>lib/WifiConnector.py"]
Boot --> Status["系统状态LED<br/>lib/SystemStatus.py"]
Status --> Breath["呼吸LED引擎<br/>lib/BreathLED.py"]
Main --> DB["业务数据(JSONL)<br/>data/*.jsonl"]
Main --> Static["前端资源<br/>static/*"]
Main --> Config["系统配置<br/>data/config.json, data/settings.json"]
```

图表来源
- [boot.py](file://boot.py#L1-L122)
- [main.py](file://main.py#L1-L548)
- [WifiConnector.py](file://lib/WifiConnector.py#L1-L800)
- [SystemStatus.py](file://lib/SystemStatus.py#L1-L61)
- [BreathLED.py](file://lib/BreathLED.py#L1-L633)
- [config.json](file://data/config.json#L1-L6)
- [settings.json](file://data/settings.json#L1-L1)

章节来源
- [boot.py](file://boot.py#L1-L122)
- [main.py](file://main.py#L1-L548)

## 核心组件
- 引导与启动：boot.py 负责CPU频率设置、WiFi连接尝试、AP模式降级、LED状态指示、应用启动与系统状态打印。
- WiFi连接：lib/WifiConnector.py 提供网络扫描、连接、重连、断开、热点创建、静态IP配置、诊断与配置持久化。
- 系统状态LED：lib/SystemStatus.py 与 lib/BreathLED.py 提供单LED呼吸指示（连接/AP/运行三种模式）。
- Web应用与API：main.py 提供静态资源路由、业务API（Poems/Members/Activities/Tasks/Finance）、系统信息查询。
- 数据与配置：data/ 目录下各业务JSONL文件与系统配置文件，负责数据持久化与系统行为控制。

章节来源
- [boot.py](file://boot.py#L1-L122)
- [WifiConnector.py](file://lib/WifiConnector.py#L1-L800)
- [SystemStatus.py](file://lib/SystemStatus.py#L1-L61)
- [BreathLED.py](file://lib/BreathLED.py#L1-L633)
- [main.py](file://main.py#L1-L548)
- [config.json](file://data/config.json#L1-L6)
- [settings.json](file://data/settings.json#L1-L1)

## 架构总览
系统启动顺序与交互如下：
- boot.py 初始化WiFi连接器、加载配置、尝试连接WiFi，失败则进入AP模式；随后启动main应用并打印系统状态。
- main.py 提供HTTP服务，路由静态资源与业务API；业务数据以JSONL形式存储，settings.json提供系统设置。
- WiFi服务由WifiConnector统一管理，支持连接、重连、热点、诊断与配置持久化。
- SystemStatus与BreathLED共同提供LED状态指示，区分连接中、AP模式、运行中三种状态。

```mermaid
sequenceDiagram
participant Boot as "引导层<br/>boot.py"
participant Wifi as "WiFi服务<br/>WifiConnector"
participant Main as "应用层<br/>main.py"
participant LED as "系统状态LED<br/>SystemStatus/BreathLED"
Boot->>Wifi : 初始化并加载配置
Boot->>Wifi : connect(ssid,password)
Wifi-->>Boot : 连接成功/失败
alt 连接失败
Boot->>Wifi : create_hotspot(...)
Wifi-->>Boot : AP启动成功/失败
Boot->>LED : start_ap_mode()
else 连接成功
Boot->>Main : 启动应用(app.run)
Boot->>LED : start_running()
end
Main->>Main : 提供API与静态资源
```

图表来源
- [boot.py](file://boot.py#L22-L87)
- [WifiConnector.py](file://lib/WifiConnector.py#L595-L760)
- [main.py](file://main.py#L541-L548)
- [SystemStatus.py](file://lib/SystemStatus.py#L33-L46)

## 详细组件分析

### 组件A：引导与启动流程（boot.py）
- CPU频率设置与调试输出。
- 配置加载与WiFi连接尝试，失败则进入AP模式。
- LED状态指示：连接中、AP模式、运行中。
- 应用启动与系统状态打印。

```mermaid
flowchart TD
Start(["启动"]) --> Freq["设置CPU频率"]
Freq --> LoadCfg["加载配置"]
LoadCfg --> TryConn{"尝试WiFi连接"}
TryConn --> |成功| RunApp["启动main应用"]
TryConn --> |失败| StartAP["创建AP热点"]
StartAP --> LedAp["LED: AP模式"]
RunApp --> LedRun["LED: 运行中"]
LedAp --> End(["完成"])
LedRun --> End
```

图表来源
- [boot.py](file://boot.py#L8-L122)

章节来源
- [boot.py](file://boot.py#L8-L122)

### 组件B：WiFi连接与热点管理（lib/WifiConnector.py）
- 网络扫描与连接：支持超时、重试、状态监控与诊断。
- 静态IP管理：配置、验证、切换、便捷访问器。
- 热点创建与管理：IP配置、客户端管理、配置持久化。
- 资源管理：断开、忘记网络、清理。

```mermaid
classDiagram
class WifiConnector {
+connect(ssid, password, timeout, static_ip)
+disconnect(keep_credentials)
+reconnect(max_attempts)
+forget_network()
+scan_networks(timeout)
+find_network(ssid)
+create_hotspot(ssid, password, channel, max_clients, authmode, ip_config)
+get_hotspot_info()
+get_diagnostics()
+save_config(file, include_password)
+load_config(file)
+configure_static_ip(cfg)
+switch_to_static_ip(ip, gateway)
+switch_to_dhcp()
+get_ip_mode()
+get_static_ip_config()
+get_last_error()
}
```

图表来源
- [WifiConnector.py](file://lib/WifiConnector.py#L11-L800)

章节来源
- [WifiConnector.py](file://lib/WifiConnector.py#L11-L800)

### 组件C：系统状态LED（lib/SystemStatus.py 与 lib/BreathLED.py）
- SystemStatus：封装单LED呼吸周期，提供连接中、AP模式、运行中三种状态。
- BreathLED：通用LED呼吸引擎，支持WS2812与普通LED，提供精确次数控制、自动停止、优先级管理等。

```mermaid
classDiagram
class SystemStatus {
+start_connecting()
+start_ap_mode()
+start_running()
+stop()
-_set_cycle(cycle)
}
class BreathLED {
+start()
+breath(cycles)
+breath_once()
+stop()
+cleanup()
+set_color(color)
+set_brightness_range(min,max)
+set_breath_cycle(ms)
+is_running()
+get_status()
+get_current_brightness()
}
SystemStatus --> BreathLED : "使用"
```

图表来源
- [SystemStatus.py](file://lib/SystemStatus.py#L19-L61)
- [BreathLED.py](file://lib/BreathLED.py#L11-L633)

章节来源
- [SystemStatus.py](file://lib/SystemStatus.py#L19-L61)
- [BreathLED.py](file://lib/BreathLED.py#L11-L633)

### 组件D：Web应用与API（main.py）
- 静态资源路由：index.html、style.css、app.js、logo.png。
- 业务API：Poems、Members、Activities、Tasks、Finance、登录、系统信息。
- 数据模型：JsonlDB（JSONL数据库），支持追加、更新、删除、分页检索、迁移旧JSON。

```mermaid
sequenceDiagram
participant Client as "浏览器"
participant Main as "main.py"
participant DB as "JsonlDB"
participant FS as "文件系统"
Client->>Main : GET /api/poems?page&limit&q
Main->>DB : fetch_page(page, limit, reverse, search_term)
DB->>FS : 读取data/poems.jsonl
FS-->>DB : 行记录
DB-->>Main : 结果集
Main-->>Client : JSON响应
```

图表来源
- [main.py](file://main.py#L299-L370)
- [main.py](file://main.py#L53-L260)

章节来源
- [main.py](file://main.py#L299-L370)
- [main.py](file://main.py#L53-L260)

## 依赖分析
- boot.py 依赖 WifiConnector 与 SystemStatus。
- main.py 依赖 microdot（HTTP框架）、JsonlDB（数据访问）、network/time/os/gc 等。
- WifiConnector 依赖 network、ubinascii、ujson、time。
- SystemStatus 依赖 BreathLED。
- 前端 index.html 依赖 static/app.js 与 style.css。

```mermaid
graph LR
Boot["boot.py"] --> Wifi["lib/WifiConnector.py"]
Boot --> Status["lib/SystemStatus.py"]
Status --> Breath["lib/BreathLED.py"]
Main["main.py"] --> Microdot["lib/microdot.py"]
Main --> Jsonl["JsonlDB(data/*.jsonl)"]
Main --> Settings["data/settings.json"]
Main --> Static["static/*"]
```

图表来源
- [boot.py](file://boot.py#L1-L12)
- [main.py](file://main.py#L10-L17)
- [WifiConnector.py](file://lib/WifiConnector.py#L6-L11)
- [SystemStatus.py](file://lib/SystemStatus.py#L10-L11)

章节来源
- [boot.py](file://boot.py#L1-L12)
- [main.py](file://main.py#L10-L17)

## 性能考虑
- 内存与GC：main.py 在系统状态打印与API调用前后使用 gc.collect()，有助于释放内存。
- 网络同步：WifiConnector 支持智能网络信息同步与强制同步间隔，避免频繁底层查询。
- LED更新：BreathLED 使用预计算正弦查找表与自适应更新间隔，降低CPU占用。
- JSONL读写：main.py 的JsonlDB采用逐行扫描与偏移定位，支持分页与搜索，注意大数据量时的I/O与内存压力。

章节来源
- [main.py](file://main.py#L279-L294)
- [WifiConnector.py](file://lib/WifiConnector.py#L253-L326)
- [BreathLED.py](file://lib/BreathLED.py#L72-L89)
- [main.py](file://main.py#L113-L186)

## 故障排除指南

### 一、WiFi连接问题
常见症状
- 设备无法连接到路由器，反复尝试失败。
- 连接后无法获取IP或频繁掉线。
- 信号弱导致连接不稳定。

排查步骤
1. 检查配置文件
   - 确认 data/config.json 中的 wifi_ssid 与 wifi_password 是否正确。
   - 若SSID仍为默认占位符，系统将自动进入AP模式。
   - 参考：[config.json](file://data/config.json#L1-L6)

2. 启用调试与查看错误
   - boot.py 初始化 WifiConnector 时传入 debug=True，可输出连接状态与错误。
   - 使用 WifiConnector.get_last_error() 获取最近错误信息。
   - 参考：[boot.py](file://boot.py#L11-L12)、[WifiConnector.py](file://lib/WifiConnector.py#L140-L148)

3. 连接状态监控与重连
   - 使用 WifiConnector.monitor_connection() 定期监控连接状态。
   - 使用 reconnect(max_attempts) 进行自动重连。
   - 参考：[WifiConnector.py](file://lib/WifiConnector.py#L761-L800)

4. 静态IP与DHCP切换
   - 若网络环境需要固定IP，使用 configure_static_ip() 或 switch_to_static_ip()。
   - 使用 get_ip_mode() 检查当前IP模式（dhcp/static）。
   - 参考：[WifiConnector.py](file://lib/WifiConnector.py#L432-L502)、[WifiConnector.py](file://lib/WifiConnector.py#L197-L234)

5. 热点创建与诊断
   - 连接失败时进入AP模式，可通过 create_hotspot() 创建热点，便于本地调试。
   - 使用 get_diagnostics() 获取系统诊断信息。
   - 参考：[boot.py](file://boot.py#L65-L87)、[WifiConnector.py](file://lib/WifiConnector.py#L280-L289)

6. 日志与调试工具
   - 启动时 boot.py 会打印文件列表与等待时间，便于上传/调试。
   - 使用 wifi_connector_example.py 进行连接、扫描、热点等测试。
   - 参考：[boot.py](file://boot.py#L92-L103)、[wifi_connector_example.py](file://lib/wifi_connector_example.py#L1-L787)

章节来源
- [config.json](file://data/config.json#L1-L6)
- [boot.py](file://boot.py#L11-L12)
- [WifiConnector.py](file://lib/WifiConnector.py#L140-L148)
- [WifiConnector.py](file://lib/WifiConnector.py#L761-L800)
- [WifiConnector.py](file://lib/WifiConnector.py#L432-L502)
- [WifiConnector.py](file://lib/WifiConnector.py#L197-L234)
- [boot.py](file://boot.py#L65-L87)
- [WifiConnector.py](file://lib/WifiConnector.py#L280-L289)
- [boot.py](file://boot.py#L92-L103)
- [wifi_connector_example.py](file://lib/wifi_connector_example.py#L1-L787)

### 二、系统启动故障
常见症状
- 设备启动后无响应或卡死。
- LED状态异常（不亮/常亮/闪烁异常）。
- 应用无法启动或端口占用。

排查步骤
1. CPU频率与等待
   - boot.py 设置CPU频率并打印当前频率；启动后有短暂等待时间，便于上传文件。
   - 参考：[boot.py](file://boot.py#L8-L12)、[boot.py](file://boot.py#L100-L103)

2. LED状态指示
   - SystemStatus 提供 start_connecting()/start_ap_mode()/start_running() 三态指示。
   - 若LED初始化失败，会打印错误信息；可通过 status_led.stop() 停止。
   - 参考：[SystemStatus.py](file://lib/SystemStatus.py#L25-L32)、[SystemStatus.py](file://lib/SystemStatus.py#L33-L46)

3. 应用启动
   - boot.py 在启动main.py后，打印系统状态并运行app；若启动失败会输出错误。
   - 参考：[boot.py](file://boot.py#L105-L122)、[main.py](file://main.py#L541-L548)

4. 文件与路径
   - boot.py 会列出根目录与static目录，确认静态资源是否存在。
   - 参考：[boot.py](file://boot.py#L92-L98)

章节来源
- [boot.py](file://boot.py#L8-L12)
- [boot.py](file://boot.py#L100-L103)
- [SystemStatus.py](file://lib/SystemStatus.py#L25-L32)
- [SystemStatus.py](file://lib/SystemStatus.py#L33-L46)
- [boot.py](file://boot.py#L105-L122)
- [main.py](file://main.py#L541-L548)
- [boot.py](file://boot.py#L92-L98)

### 三、网络配置错误
常见症状
- 配置文件损坏或缺失。
- 静态IP配置无效或冲突。
- 热点IP与路由器网段冲突。

排查步骤
1. 配置文件校验
   - data/config.json 与 data/settings.json 格式应为合法JSON。
   - main.py 在启动时会尝试读取 settings.json；若不存在则返回空字典。
   - 参考：[main.py](file://main.py#L269-L277)、[settings.json](file://data/settings.json#L1-L1)

2. 静态IP配置
   - 使用 WifiConnector._validate_ip_address() 与 _validate_subnet_mask() 进行格式校验。
   - 使用 configure_static_ip() 或 connect_with_static_ip() 配置静态IP。
   - 参考：[WifiConnector.py](file://lib/WifiConnector.py#L363-L411)、[WifiConnector.py](file://lib/WifiConnector.py#L432-L497)

3. 热点IP配置
   - create_hotspot() 支持自定义IP配置；若与路由器网段冲突，可能导致设备无法访问。
   - 参考：[boot.py](file://boot.py#L72-L86)、[WifiConnector.py](file://lib/WifiConnector.py#L235-L279)

4. 配置持久化
   - 使用 save_config()/load_config() 保存/加载WiFi配置；注意是否包含密码。
   - 参考：[wifi_connector_example.py](file://lib/wifi_connector_example.py#L472-L508)

章节来源
- [main.py](file://main.py#L269-L277)
- [settings.json](file://data/settings.json#L1-L1)
- [WifiConnector.py](file://lib/WifiConnector.py#L363-L411)
- [WifiConnector.py](file://lib/WifiConnector.py#L432-L497)
- [boot.py](file://boot.py#L72-L86)
- [WifiConnector.py](file://lib/WifiConnector.py#L235-L279)
- [wifi_connector_example.py](file://lib/wifi_connector_example.py#L472-L508)

### 四、硬件兼容性问题
常见症状
- LED不工作或闪烁异常。
- WiFi模块初始化失败或报错。
- PWM频率/引脚不匹配。

排查步骤
1. LED兼容性
   - SystemStatus 默认使用GPIO 15；若硬件不同，需调整引脚。
   - BreathLED 支持WS2812与普通LED，注意引脚范围与亮度范围。
   - 参考：[SystemStatus.py](file://lib/SystemStatus.py#L27-L31)、[BreathLED.py](file://lib/BreathLED.py#L94-L169)

2. WiFi模块
   - WifiConnector 通过 network.WLAN 初始化STA/AP接口；若报“内部错误”，建议重置模块。
   - 参考：[WifiConnector.py](file://lib/WifiConnector.py#L341-L362)

3. 调试与示例
   - 使用 breath_led_example.py 与 wifi_connector_example.py 进行硬件与功能验证。
   - 参考：[breath_led_example.py](file://lib/breath_led_example.py#L1-L199)、[wifi_connector_example.py](file://lib/wifi_connector_example.py#L1-L787)

章节来源
- [SystemStatus.py](file://lib/SystemStatus.py#L27-L31)
- [BreathLED.py](file://lib/BreathLED.py#L94-L169)
- [WifiConnector.py](file://lib/WifiConnector.py#L341-L362)
- [breath_led_example.py](file://lib/breath_led_example.py#L1-L199)
- [wifi_connector_example.py](file://lib/wifi_connector_example.py#L1-L787)

### 五、日志分析与调试工具
- 启动日志
  - boot.py 打印CPU频率、文件列表、等待提示，便于判断启动阶段问题。
  - 参考：[boot.py](file://boot.py#L8-L12)、[boot.py](file://boot.py#L92-L103)

- WiFi错误日志
  - WifiConnector 内部统一日志输出，错误通过 _set_error() 记录；可通过 get_last_error() 获取。
  - 参考：[WifiConnector.py](file://lib/WifiConnector.py#L135-L148)

- 系统状态
  - main.py 提供 print_system_status() 打印WiFi IP与内存信息。
  - 参考：[main.py](file://main.py#L279-L294)

- 调试示例
  - wifi_connector_example.py 与 breath_led_example.py 提供完整测试流程，便于复现与定位问题。
  - 参考：[wifi_connector_example.py](file://lib/wifi_connector_example.py#L1-L787)、[breath_led_example.py](file://lib/breath_led_example.py#L1-L199)

章节来源
- [boot.py](file://boot.py#L8-L12)
- [boot.py](file://boot.py#L92-L103)
- [WifiConnector.py](file://lib/WifiConnector.py#L135-L148)
- [main.py](file://main.py#L279-L294)
- [wifi_connector_example.py](file://lib/wifi_connector_example.py#L1-L787)
- [breath_led_example.py](file://lib/breath_led_example.py#L1-L199)

### 六、性能问题定位
- 内存与GC
  - main.py 在关键位置调用 gc.collect()，建议在高频API调用前后观察内存变化。
  - 参考：[main.py](file://main.py#L289-L292)

- LED性能
  - BreathLED 使用正弦查找表与自适应更新间隔，避免过度CPU占用；若出现闪烁抖动，可调整 UPDATE_INTERVAL_MIN 与 UPDATE_INTERVAL_DIVISOR。
  - 参考：[SystemStatus.py](file://lib/SystemStatus.py#L14-L18)、[BreathLED.py](file://lib/BreathLED.py#L54-L57)

- 网络同步
  - WifiConnector 的 sync_interval 与 force_sync_interval 控制网络信息同步频率，可根据网络稳定性调整。
  - 参考：[WifiConnector.py](file://lib/WifiConnector.py#L112-L115)、[WifiConnector.py](file://lib/WifiConnector.py#L291-L326)

章节来源
- [main.py](file://main.py#L289-L292)
- [SystemStatus.py](file://lib/SystemStatus.py#L14-L18)
- [BreathLED.py](file://lib/BreathLED.py#L54-L57)
- [WifiConnector.py](file://lib/WifiConnector.py#L112-L115)
- [WifiConnector.py](file://lib/WifiConnector.py#L291-L326)

### 七、紧急恢复与数据修复
- 紧急恢复流程
  - 若应用无法启动，检查 boot.py 启动日志与 main.py 错误输出。
  - 若WiFi无法连接，进入AP模式（boot.py 已内置），使用热点访问本地服务。
  - 参考：[boot.py](file://boot.py#L65-L87)、[boot.py](file://boot.py#L105-L122)

- 数据修复
  - JsonlDB 支持旧版 .json 迁移到 .jsonl；若迁移失败，检查文件权限与磁盘空间。
  - 参考：[main.py](file://main.py#L68-L84)

- 配置恢复
  - 使用 save_config()/load_config() 恢复WiFi配置；若配置损坏，可删除配置文件后重新配置。
  - 参考：[wifi_connector_example.py](file://lib/wifi_connector_example.py#L472-L508)

章节来源
- [boot.py](file://boot.py#L65-L87)
- [boot.py](file://boot.py#L105-L122)
- [main.py](file://main.py#L68-L84)
- [wifi_connector_example.py](file://lib/wifi_connector_example.py#L472-L508)

### 八、问题报告与反馈机制
- 问题分类
  - 硬件相关：LED、WiFi模块、引脚配置。
  - 软件相关：启动失败、API异常、数据损坏、性能问题。
  - 网络相关：连接失败、IP冲突、热点不可用。

- 报告要素
  - 系统版本与固件信息（CPU频率、平台信息）。
  - 配置文件内容（脱敏处理）。
  - 日志片段（boot/main/WiFi）。
  - 复现步骤与期望/实际结果。
  - 硬件平台与引脚配置。

- 反馈渠道
  - 仓库Issue：提供问题描述、日志与复现步骤。
  - 示例代码：附带 wifi_connector_example.py 与 breath_led_example.py 的最小复现。

章节来源
- [boot.py](file://boot.py#L92-L103)
- [main.py](file://main.py#L541-L548)
- [wifi_connector_example.py](file://lib/wifi_connector_example.py#L1-L787)
- [breath_led_example.py](file://lib/breath_led_example.py#L1-L199)

## 结论
本故障排除手册基于项目实际代码与配置，提供了从启动、网络、LED、API到数据与配置的全链路排查方法。建议在日常运维中：
- 启用调试日志，定期检查系统状态与内存使用。
- 使用 WifiConnector 的监控与诊断能力，提前发现连接问题。
- 通过示例程序快速验证硬件与功能，缩短定位时间。
- 建立问题报告模板，提升反馈效率与问题解决速度。

## 附录
- 前端页面：index.html 提供导航、搜索、各模块入口与模态框，便于本地调试与问题复现。
  - 参考：[index.html](file://static/index.html#L1-L269)

章节来源
- [index.html](file://static/index.html#L1-L269)