---
trigger: always_on
alwaysApply: true
---

# 围炉诗社·理事台 技术开发规范 (Rules)

本文档定义了项目的开发规范、架构设计原则和代码风格，旨在确保后续开发的一致性和系统在资源受限环境（ESP32 MicroPython）下的稳定性。

## 1. 项目概述
- **项目名称**: 围炉诗社·理事台 (Weilushishe Lishitai)
- **开发平台**: ESP32S2 WEMOS S2 mini
  - MicroPython环境：MicroPython v1.25.0 on 2025-04-15; LOLIN_S2_MINI with ESP32-S2FN4R2
  - 主控芯片：ESP32-S2FN4R2
  - 开发版官方文档网址：https://www.wemos.cc/en/latest/s2/s2_mini.html
  - 开发版可用资源:
    - 主控参数: CPU 240MHz 320KB SRAM
    - 系统资源: 
      - 2MB 剩余可用Flash
      - 2MB PSRAM
    - GPIO 15 连接蓝色LED，高电平点亮LED
    - GPIO 0 连接按键，按下为低电平
- **运行环境**: MicroPython
- **系统语言**: 中文界面、中文文案、中文注释
- **功能目标**: 诗歌管理、活动管理、事务管理、成员管理、财务统计及系统监控、用户登陆日志和数据维护。
- **总体规范**:  
  - 开发环境和生产环境使用不同日志级别。
  - 尽量不要改动第三方库封装的源代码，优先通过外部方法调用来实现功能，若需改动必须先进行确认。
  - 实现看门狗机制，防止系统锁死。

## 2. 目录结构规范
- `doc`: 存放项目参考资料和说明文档。
- `src/boot.py`: 系统引导程序，负责底层硬件初始化、WiFi 连接及基础环境检查。
- `src/main.py`: 主业务逻辑入口，包含 Web 服务器启动、API 路由定义及全局调度。
- `src/lib/`: 核心功能组件库（如 WiFi 管理、LED 控制、数据库引擎等）。
- `src/data/`: 持久化存储目录。配置文件采用 `.json`，业务数据采用 `.jsonl` (JSON Lines)。
- `src/static/`: Web 前端资源（HTML, CSS, JS）。
- `README.md`: 项目简介和基础使用说明。

## 3. 前后端开发规范

### 3.1 Python (后端)
- **命名规范**:
  - 变量/函数/方法: `snake_case` (例如: `fetch_page`, `user_id`)
  - 类名: `PascalCase` (例如: `JsonlDB`, `WifiConnector`)
  - 常量: `UPPER_SNAKE_CASE` (例如: `DEFAULT_SCAN_TIMEOUT`)
- **性能建议**:
  - 在完成大对象处理或文件读写后，显式调用 `gc.collect()` 释放内存。
  - 避免一次性加载整个大型 JSON 文件，优先使用行扫描或生成器。
  - 适当利用内存，减少Flash读写，提高Web响应速度，平衡CPU计算资源和内存资源，避免内存泄漏。
- **安全控制**:
  - 后端接口API严格按需求控制访问权限。
  - 所有需用户登陆才可访问的接口均实现登陆鉴权。

### 3.2 JavaScript (前端)
- **UI设计**：
  - 全站统一主题色和风格
  - 适配移动端、平板端和PC端，断点判定：移动端小于768px、平板端小于1280px、PC端大于等于1280px
- **命名规范**:
  - 变量/函数: `camelCase` (例如: `checkLogin`, `showSection`)
  - 全局常量: `UPPER_SNAKE_CASE` (例如: `API_BASE`)
- **交互逻辑**:
  - 采用 SPA (单页应用) 架构，通过 `showSection` 切换视图。
  - 使用 `async/await` 处理所有异步 fetch 请求。
  - 敏感操作（如删除、重要修改）必须提供用户确认弹窗。
- **数据存储**:
  - 常用状态存储于 `localStorage`。
  - 复杂数据草稿（如未发布的诗歌）存储于 `IndexedDB`。
- **CSS样式**:
  - 使用CSS变量来提高代码效率
  - 尽量避免直接添加行内样式，js控制页面变化可结合CSS来控制外观变化


## 4. 数据库设计规范 (JSONL)
- **格式选择**: 业务数据必须使用 `.jsonl` 格式，以支持流式读写，降低内存占用。
- **写入规则**: 采用 `append` 方式写入新记录。
- **更新规则**: 采用“读取-修改-重写临时文件-原子替换”模式，确保数据一致性。
- **ID 管理**: 必须包含数值型 `id` 字段，通过扫描文件获取最大 ID 实现自增。
- **结构同步**: 若更改数据库结构，应该同步更新数据库文件`.json`和`.jsonl`的模版文件。

## 5. Web API 规范
- **框架**: 使用 `lib/microdot.py` 轻量级 Web 框架。
- **路径规范**:
  - 静态资源: `/` (根路径) 或直接映射文件名。
  - API 接口: 统一以 `/api` 开头 (例如: `/api/poems`, `/api/members`)。
- **数据格式**: 请求与响应统一使用 JSON。
- **分页机制**: 数据查询接口必须支持 `page` 和 `limit` 参数，实现服务端分页。

## 6. 硬件与环境约束
- **内存限制**: ESP32 内存有限，禁止创建巨大的列表或字典副本。
- **网络鲁棒性**: 必须实现 WiFi 自动重连机制和 AP/STA 模式自动切换逻辑。
- **状态指示**: 关键系统状态（启动、连接中、错误、数据写入）应通过 LED (BreathLED) 进行视觉反馈。

## 7. 版本控制与发布
- 新增、删除、修改主要功能应该同步更新 README 文档和版本号（如 v1.0.0）。
